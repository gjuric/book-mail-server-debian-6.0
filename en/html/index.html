<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Building a mail server on Debian 6.0</title><link rel="stylesheet" href="docbook.css" type="text/css" /><meta name="generator" content="DocBook XSL Stylesheets V1.75.0" /><link rel="home" href="#id36885449" title="Building a mail server on Debian 6.0" /><link rel="next" href="#id36885396" title="Foreword" /></head><body><div class="book" title="Building a mail server on Debian 6.0"><div class="titlepage"><div><div><h1 class="title"><a id="id36885449"></a>Building a mail server on Debian 6.0</h1></div><div><div class="author"><h3 class="author"><span class="firstname">Goran</span> <span class="surname">Jurić</span></h3></div></div><div><p class="releaseinfo">
      This is version 0.0.1 of Building a mail server on Debian.
    </p></div><div><p class="copyright">Copyright © 2010 Goran Jurić</p></div><div><div class="legalnotice" title="Legal Notices"><a id="id36885427"></a>
      <p class="legalnotice-title"><b>Legal Notices</b></p>

      <p>Permission is granted to copy, distribute and/or modify this
      document under the terms of the GNU Free Documentation
      License (GFDL), Version 1.1 or any later version published
      by the Free Software Foundation with no Invariant Sections,
      no Front-Cover Texts, and no Back-Cover Texts.  You can find
      a copy of the GFDL at this
      <a class="link" href="http://www.gnu.org/copyleft/fdl.html" target="_top">link</a>.
      </p>
    </div></div></div><hr /></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="preface"><a href="#id36885396">Foreword</a></span></dt><dt><span class="chapter"><a href="#introduction">1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#introduction.why.postfix">1.1. Why Postfix</a></span></dt><dt><span class="section"><a href="#introduction.why.debian">1.2. Why Debian</a></span></dt><dt><span class="section"><a href="#introduction.software-used">1.3. Sofware used</a></span></dt><dt><span class="section"><a href="#introduction.required-knowledge">1.4. Required knowledge</a></span></dt></dl></dd><dt><span class="chapter"><a href="#preparation">2. Preparation</a></span></dt><dd><dl><dt><span class="section"><a href="#preparation.debian-installation">2.1. Debian installation</a></span></dt><dt><span class="section"><a href="#preparation.tracking-changes">2.2. Tracking configuration changes</a></span></dt><dt><span class="section"><a href="#preparation.essentials">2.3. Essential software</a></span></dt><dt><span class="section"><a href="#preparation.static-ip">2.4. Setting a static IP address</a></span></dt><dt><span class="section"><a href="#dns">2.5. DNS settings</a></span></dt><dt><span class="section"><a href="#preparation.ntp">2.6. NTP - time synchronization</a></span></dt><dt><span class="section"><a href="#preparation.lamp">2.7. Apache, MySQL and PHP</a></span></dt></dl></dd><dt><span class="chapter"><a href="#security">3. Security</a></span></dt><dd><dl><dt><span class="section"><a href="#security.certificates">3.1. Server certificates</a></span></dt><dt><span class="section"><a href="#security.firewall">3.2. Firewall</a></span></dt><dt><span class="section"><a href="#security.limiting-ssh">3.3. Limiting SSH access</a></span></dt><dt><span class="section"><a href="#security.intrusion-detection">3.4. Intrusion detection</a></span></dt></dl></dd><dt><span class="chapter"><a href="#mail-server">4. Mail server</a></span></dt><dd><dl><dt><span class="section"><a href="#postfix">4.1. Postfix</a></span></dt><dd><dl><dt><span class="section"><a href="#postfix.inital-settings">4.1.1. Initial settings</a></span></dt><dt><span class="section"><a href="#postfix.virtual-users">4.1.2. Virtual users and domains</a></span></dt><dt><span class="section"><a href="#postfix.mysql">4.1.3. MySQL</a></span></dt><dt><span class="section"><a href="#postfix.sasl">4.1.4. Saslauthd</a></span></dt><dt><span class="section"><a href="#postfix.acl">4.1.5. Preventing unwanted access</a></span></dt><dt><span class="section"><a href="#postfix.tls">4.1.6. TLS</a></span></dt><dt><span class="section"><a href="#id36888137">4.1.7. Submission port</a></span></dt><dt><span class="section"><a href="#id36888170">4.1.8. Blocking certain attachments</a></span></dt><dt><span class="section"><a href="#id36888203">4.1.9. Maximum message size</a></span></dt><dt><span class="section"><a href="#id36888222">4.1.10. Commit your changes</a></span></dt><dt><span class="section"><a href="#id36888237">4.1.11. Important commands</a></span></dt></dl></dd><dt><span class="section"><a href="#courier">4.2. Courier</a></span></dt><dd><dl><dt><span class="section"><a href="#courier.installation">4.2.1. Installation</a></span></dt><dt><span class="section"><a href="#courier.certificates">4.2.2. Use certificates</a></span></dt><dt><span class="section"><a href="#courier.firewall-rules">4.2.3. Firewall rules</a></span></dt><dt><span class="section"><a href="#courier.commit-changes">4.2.4. Commit your changes</a></span></dt></dl></dd><dt><span class="section"><a href="#antispam">4.3. Fighting spam</a></span></dt><dd><dl><dt><span class="section"><a href="#antispam.clamav">4.3.1. ClamAV</a></span></dt><dt><span class="section"><a href="#antispam.spamassassin">4.3.2. SpamAssassin</a></span></dt><dt><span class="section"><a href="#antispam.amavis">4.3.3. Amavisd-new</a></span></dt><dt><span class="section"><a href="#antispam.dkim">4.3.4. DKIM</a></span></dt><dt><span class="section"><a href="#id36889377">4.3.5. RBL lists</a></span></dt><dt><span class="section"><a href="#antispam.greylisting">4.3.6. Greylisting</a></span></dt></dl></dd><dt><span class="section"><a href="#utilities">4.4. Utilities</a></span></dt><dd><dl><dt><span class="section"><a href="#utilities.maildrop">4.4.1. Maildrop</a></span></dt><dt><span class="section"><a href="#id36889545">4.4.2. Vacation</a></span></dt><dt><span class="section"><a href="#id36889820">4.4.3. Mailing lists</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#todo">5. TODO</a></span></dt></dl></div>
  

  <div class="preface" title="Foreword"><div class="titlepage"><div><div><h2 class="title"><a id="id36885396"></a>Foreword</h2></div></div></div>
    

    <p>The internet is full of information on how to do just about
    anything. But this vast amount of information makes it hard to find and
    glue all of the pieces to fit together.</p>

    <p>The goal of this manual is to provide you with enough knowledge to
    feel confident in installing and maintaing your own mail server. Of course
    manuals like this already exist but during my search for knowledge I
    always felt like they were either not updated in a while or they just skip
    over some of the most interesting parts assuming you know what they are
    talking about.</p>

    <p>I will do my best to explain why and not just how.</p>

    <p>This manual does not even come close to explaining the intricacies
    of a Postfix mail server. If you want to know more you really should read
    "The Book of Postfix: State-of-the-Art Message Transport" by Ralf
    Hildebrandt and Patrick Koetter.</p>
  </div>

  <div class="chapter" title="Chapter 1. Introduction"><div class="titlepage"><div><div><h2 class="title"><a id="introduction"></a>Chapter 1. Introduction</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#introduction.why.postfix">1.1. Why Postfix</a></span></dt><dt><span class="section"><a href="#introduction.why.debian">1.2. Why Debian</a></span></dt><dt><span class="section"><a href="#introduction.software-used">1.3. Sofware used</a></span></dt><dt><span class="section"><a href="#introduction.required-knowledge">1.4. Required knowledge</a></span></dt></dl></div>
  

  <div class="section" title="1.1. Why Postfix"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="introduction.why.postfix"></a>1.1. Why Postfix</h2></div></div></div>
    

    <p>Most of you know that there are a number of different distributions
    and mail transfer agents that could be used to build an equally capable
    mail server.</p>

    <p>The only other mail server I had experience working on is build on
    CentOS and it is called <code class="uri"><a class="uri" href="http://www.qmailtoaster.com/" target="_top">Qmail Toaster</a></code>. Qmail Toaster has a lot of
    strengths. It is a ready made software library which you can install and
    the installer will take care of setting up a bunch of different programs
    and utilities that are needed for a mail server.</p>

    <p>On the other hand, from what I have seen, it has it's share of
    quirks and the biggest one for me is that it uses Qmail. Qmail is not a
    bad MTA (Mail Transfer Agent) but it is not being actively developed for
    years and a lot of the functionality is provided through patches.</p>

    <p>Postfix is on the other hand an actively developed project and all
    of the requirements a modern mail server could have are either present in
    Postfix itself or they can be provided through other applications.</p>
  </div>

  <div class="section" title="1.2. Why Debian"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="introduction.why.debian"></a>1.2. Why Debian</h2></div></div></div>
    

    <p>Debian 3.0 (woody) is the first distribution I installed on a server
    and since than I fell in live with it. Debian was at the time the
    distribution with most packages provided in their repositories. Some of
    you maybe like to compile their own software, but for me software provided
    through distributions package management was always easier to maintain and
    upgrade and not to mention stable.</p>

    <p>CentOS is also a nice distribution, but the version of Postfix
    shipped with the current release of Centos (5.6 at the time of writing) is
    ancient and is not really even supported by the author. Not to mention
    that the number of software packages provided through the official
    repositories does not even come close to Debians.</p>

    <p>Software in the stable Debian distribution may be older than the one
    provided in Ubuntu, but I have more trust in Debian. Your milage may
    vary.</p>
  </div>

  <div class="section" title="1.3. Sofware used"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="introduction.software-used"></a>1.3. Sofware used</h2></div></div></div>
    

    <p>Here is a short list of applications we are going to use to build a
    mail server.</p>

    <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
        <p>Postfix - Mail Transfer Agent</p>
      </li><li class="listitem">
        <p>Courier - an IMAP/POP3 server</p>
      </li><li class="listitem">
        <p>SpamAssassin - for filtering spam messages</p>
      </li><li class="listitem">
        <p>ClamAV - antivirus</p>
      </li><li class="listitem">
        <p>Amavisd-new - a glue that glues Postfix with SpamAssassin and
        ClamAV</p>
      </li><li class="listitem">
        <p>Sqlgrey - for greylisting emails</p>
      </li><li class="listitem">
        <p>MySQL - for storing information about users, domains and
        settings</p>
      </li><li class="listitem">
        <p>Maildrop - for delivering mails to users mailboxes and quota
        support</p>
      </li></ul></div>
  </div>

  <div class="section" title="1.4. Required knowledge"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="introduction.required-knowledge"></a>1.4. Required knowledge</h2></div></div></div>
    

    <p>This is not a beginners guide to Unix. You should know your away
    around a unix shell and familiarize yourself with Debians package
    management <span class="emphasis"><em>apt</em></span>.</p>
  </div>
</div>

  <div class="chapter" title="Chapter 2. Preparation"><div class="titlepage"><div><div><h2 class="title"><a id="preparation"></a>Chapter 2. Preparation</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#preparation.debian-installation">2.1. Debian installation</a></span></dt><dt><span class="section"><a href="#preparation.tracking-changes">2.2. Tracking configuration changes</a></span></dt><dt><span class="section"><a href="#preparation.essentials">2.3. Essential software</a></span></dt><dt><span class="section"><a href="#preparation.static-ip">2.4. Setting a static IP address</a></span></dt><dt><span class="section"><a href="#dns">2.5. DNS settings</a></span></dt><dt><span class="section"><a href="#preparation.ntp">2.6. NTP - time synchronization</a></span></dt><dt><span class="section"><a href="#preparation.lamp">2.7. Apache, MySQL and PHP</a></span></dt></dl></div>
  

  <div class="section" title="2.1. Debian installation"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="preparation.debian-installation"></a>2.1. Debian installation</h2></div></div></div>
    

    <p>Download Debian 6.0 (32/64-bit PC Network installer) from <code class="uri"><a class="uri" href="http://www.debian.org/" target="_top">
    www.debian.org</a></code> and burn the image to a compact disc, or mount it as
    a CD image in your virtualisation software.</p>

    <p>Boot your computer and select Install (or Install 64 if you want the
    64-bit version). Choose your Language, Country and Keymap. If your
    computer is not connected to a network with <acronym class="acronym">DHCP</acronym> you
    will be prompted to enter network connection parameter manually. After
    configuring your network and <acronym class="acronym">DNS</acronym> server you will be
    asked for a hostname, in our case, the hostname is <code class="systemitem">atlantis</code> and our domain name is
    <code class="systemitem">example.com </code>.</p>

    <p>When prompted to select Debian mirror the selected choice is usually
    the best one. If you are not using <acronym class="acronym">HTTP</acronym> proxy on your
    internet connection, or don't know what HTTP proxy is, just leave this
    field blank.</p>

    <p>When prompted to partition the disk for a Debian install, choose
    <code class="computeroutput">Guided - use entire disk. Install all files in one
    partition</code>.</p>

    <p>Grab a cup of coffee and wait until installation finishes fetching
    packages from the internet and installs the base system.</p>

    <p>Enter your root password. This is a password for root user who has
    all the privileges on the system, so choose one carefully. After that, you
    have to create a new user for the system.</p>

    <p>You will be asked if you want to participate in the Debians
    popularity contest which collects information about most used packages.
    Feel free to answer whatever you like, by choosing Yes you are helping
    Debian community find the most used packages in the distribution. Help
    them out, it doesn't cost a thing.</p>

    <p>When prompted to select collections of software packages deselect
    everything, including the <code class="computeroutput">Standard system
    utilities</code> We just need to install the base system because
    we will add all needed packages when and if we need them.</p>

    <p>I strongly believe that you should install the minimum required
    number of packages needed for the system to operate. You will not have to
    update and upgrade packages that you do not even use. And knowing which
    package provides certain utilities is a fun exercise in getting to know
    your system a little better.</p>

    <p>Since Debian will be the only system on our machine you must install
    GRUB on to the master boot record when prompted.</p>

    <p>Your Debian system is almost ready to go. When asked, remove the
    installation media from your drive (or unmount the image in your
    virtualisation software) and reboot your computer.</p>

    <p>When your computer boots up you can log in with the root user
    account and update the packages in your system by running:</p>

    <pre class="programlisting">apt-get update
apt-get upgrade</pre>

    <p>And that's it. Your new Debian system is installed and ready for
    configuration.</p>
  </div>

  <div class="section" title="2.2. Tracking configuration changes"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="preparation.tracking-changes"></a>2.2. Tracking configuration changes</h2></div></div></div>
    

    <p>During the course of this manual, we will edit a lot of
    configuration files and install many application packages and sometimes it
    is really hard to remember what we did and why after a couple of months
    have passed.</p>

    <p>To stay on top of the game we will use
    <span class="application">etckeeper</span>.</p>

    <p>Etckeeper is an application that uses version control systems like
    git, Bazaar or Mercurial to track changes made to the <code class="filename">/etc</code> folder.</p>

    <pre class="programlisting">apt-get install etckeeper</pre>

    <p>Etckeeper in Debian uses git for tracking changes and is set to
    automatically commit all of the changes before a new package is installed
    as well as to auto commit changes on a daily bases.</p>

    <p>Since i do now want to forget to describe changes I mage to the
    files in <code class="filename">/etc</code> I usaully disable
    automatic commits. Edit <code class="filename">/etc/ectkeeper/etckeeper.conf</code>
    and uncomment out these two lines:</p>

    <pre class="programlisting">AVOID_DAILY_AUTOCOMMITS=1
AVOID_COMMIT_BEFORE_INSTALL=1</pre>

    <p>Set name and email git will use for the commit log by running this
    two commands at the shell:</p>

    <pre class="programlisting">git config --global user.name "Your Name"
git config --global user.email you@example.com</pre>

    <p>It is time for our first commit</p>

    <pre class="programlisting">etckeeper commit "Changed etckeeper settings to disable auto commits"</pre>

    <p>To view the change log navigate to the <code class="filename">/etc</code> folder and run:</p>

    <pre class="programlisting">git log</pre>

    <p>You can learn more about git and etckeeper at the projects
    homepage.</p>

    <div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
      <p>Remember to commit your changes after the each change you make or
      you will not be able to install packages because etckeeper will complain
      that there are uncommitted changes in the folder.</p>
    </div>
  </div>

  <div class="section" title="2.3. Essential software"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="preparation.essentials"></a>2.3. Essential software</h2></div></div></div>
    

    <p>First, we are going to install some software that we will use later
    in the manual.</p>

    <pre class="programlisting">apt-get install openssh-server nano dnsutils bsd-mailx telnet </pre>

    <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
         SSH server will allow us to connect remotely to the server. 
      </li><li class="listitem">
         Nano is a text editor. More user friendly than vi. 
      </li><li class="listitem">
         We will use wget to fetch stuff from the internet. 
      </li><li class="listitem">
         dnsutils package will allow us to troubleshoot possible DNS problems on our system. 
      </li><li class="listitem">
         Telnet and bsd-mailx will be used later for troubleshooting our setup. 
      </li></ul></div>
  </div>

  <div class="section" title="2.4. Setting a static IP address"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="preparation.static-ip"></a>2.4. Setting a static IP address</h2></div></div></div>
    

    <p>If you didn't enter the IP address during the installation of the
    server, you probably got an address from the DHCP server. Since servers IP
    address should not be changed you will have to set a static IP address for
    your sever.</p>

    <p>Enter ifconfig at the prompt and copy the output somewhere so you
    have access to network information you got from a DHCP server.</p>

    <p>Open up <code class="filename">/etc/network/interfaces</code> with nano and
    replace</p>

    <pre class="programlisting">auto eth0
iface eth0 inet dhcp</pre>

    <p>with</p>

    <pre class="programlisting">iface eth0 inet static
    address YOUR-IP
    netmask YOUR-NETMASK
    network YOUR-NETWORK
    broadcast YOUR-BROADCAST
    gateway YOUR-GATEWAY
    # dns-* options are implemented by the resolvconf package, if installed
    dns-nameservers YOUR-DNS-SERVERS-SEPARATED-BY-SPACE
    dns-search YOUR-DOMAIN</pre>

    <div class="caution" title="Caution" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Caution</h3>
      <p>If you are using another interface for the connection replace
      <code class="computeroutput">eth0</code> with the interface you are
      using.</p>
    </div>

    <p>Reboot your server, check that your internet connection is working
    (try to ping google.com or some other host) and if everything is ok you
    can remove packages that provide DHCP from your system.</p>

    <pre class="programlisting">
apt-get --purge remove isc-dhcp-client isc-dhcp-common</pre>

    <p>Note that option –purge removes configuration files of the packages
    we are removing. If you do not use –purge they will be left on your
    system.</p>
  </div>

  <div class="section" title="2.5. DNS settings"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="dns"></a>2.5. DNS settings</h2></div></div></div>
    

    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      <p>Mail server in this example is named <code class="systemitem">atlantis.example.com</code>. You can also name
      it <code class="systemitem">mail.example.com</code> if you
      like.</p>
    </div>

    <p>First, we need to check our hostname</p>

    <pre class="screen">atlantis:~# <span class="command"><strong>hostname -f</strong></span>
  atlantis.diabmon.com </pre>

    <p>If hostname did not return FQDN of your server edit
    <code class="filename">/etc/hosts</code>. You <code class="filename">hosts</code> file should
    look something like this, if not, change according to your IP address and
    server name.</p>

    <pre class="programlisting">127.0.0.1       localhost
  YOUR-IP-ADDRESS atlantis.example.com atlantis </pre>

    <p>Now check your <code class="filename">/etc/hostname</code> file it should
    contain your fully qualified domain name:</p>

    <pre class="programlisting">atlantis.example.com </pre>

    <p>Change the names to match your server name and reboot the server. Run
    <span class="command"><strong>hostname -f</strong></span> again and you should see <code class="systemitem">atlantis.example.com</code>.</p>

    <p>Now, we need to check that our DNS servers have an MX record for our
    <code class="systemitem">example.com</code> domain. If you
    haven't done so already Install DNS utilities:</p>

    <pre class="programlisting">apt-get install dnsutils</pre>

    <p>We are going to use <span class="command"><strong>host</strong></span> command to check
    information about our domain:</p>

    <pre class="screen">atlantis:~# <span class="command"><strong>host</strong></span> example.com
  example.com has address YOUR-IP-ADDRESS
  example.com mail is handled by 0 mail.example.com. </pre>

    <p>We can see that the mail for our domain is handled by <code class="systemitem">mail.example.com</code>. Which server is supposed
    to handle mail for your domain is handled by the so called MX records in
    your domains zone file. Setting up DNS zone files is out of scope for this
    document.</p>

    <p>Now we must make sure that <code class="systemitem">mail.example.com</code> points to the same
    address as our server (<code class="systemitem">atlantis.example.com</code>).</p>

    <pre class="screen">atlantis:~# <span class="command"><strong>nslookup</strong></span> mail.example.com
  Server: YOUR-DNS-SERVER
  Address: YOUR-DNS-ADDRESS#53

  Non-authoritative answer:
  mail.example.com canonical name = atlantis.example.com.
  Name: example.com
  Address: YOUR-IP-ADDRESS </pre>

    <p>It would be also nice if your reverse DNS points to the same name
    (<code class="systemitem">atlantis.example.com</code>).</p>

    <pre class="screen">atlantis:~# <span class="command"><strong>nslookup</strong></span> YOUR-IP-ADDRESS
  Server: YOUR-DNS-SERVER
  Address: YOUR-DNS-SERVER#53

  Non-authoritative answer: 
  YOUR-IP-ADDRES-REVERSE.in-addr.arpa name = atlantis.example.com. </pre>

    <p>If they do not match you will probably have to ask your ISP to change
    this for you.</p>
  </div>

  <div class="section" title="2.6. NTP - time synchronization"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="preparation.ntp"></a>2.6. NTP - time synchronization</h2></div></div></div>
    

    <p>Every server should have accurate time information, this is
    especially important for mail server. To make sure our servers time is
    always up to date we are going to install ntp package which enables our
    server to use NTP protocol for syncing your servers clock.</p>

    <pre class="programlisting">apt-get install ntp</pre>

    <p>If your data center or VPS provider offers an NTP service use their
    NTP server. Open up <code class="filename">/etc/ntp.conf</code> with nano and
    replace:</p>

    <pre class="programlisting">server 0.debian.pool.ntp.org iburst dynamic
server 1.debian.pool.ntp.org iburst dynamic
server 2.debian.pool.ntp.org iburst dynamic
server 3.debian.pool.ntp.org iburst dynamic</pre>

    <p>with</p>

    <pre class="programlisting">server ADDRESS-OF-NTP-SERVER-YOU-WANT-TO-USE</pre>

    <p>You should have at least two servers in the ntp.conf.</p>

    <p>After saving the changes you have to restart the NTP service by
    running</p>

    <pre class="programlisting">invoke-rc.d ntp restart</pre>

    <p>Note: invoke-rc.d is Debians shortcut to /etc/init.d/. You can run
    <code class="computeroutput">/etc/init.d/ntp restart</code> as well.</p>

    <p>You can examine if the NTP server is working as expected if you run
    the ntpq -p command:</p>

    <pre class="screen">example:~# ntpq -p

    remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
zg1.ntp.CARNet. 161.53.1.2       2 u   58   64    3    7.157  106.619   4.158
zg2.ntp.CARNet. 161.53.1.2       2 u   57   64    3    7.677   25.934   4.792
morcic.RI.CARNe 161.53.1.2       2 u   58   64    3   11.796   26.527   7.751</pre>

    <p>After a while the reach column should have values greather that 0.
    Which means that the NTP servers we are pooling for time information are
    reachable.</p>

    <div class="caution" title="Caution" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Caution</h3>
      <p>If your clock was way of from the current time NTP will not sync
      your servers time. In that case stop the NTP daemon. Set the time and
      date manually (or you can install and use the ntpdate utility) and run
      the NTP daemon again.</p>
    </div>
  </div>

  <div class="section" title="2.7. Apache, MySQL and PHP"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="preparation.lamp"></a>2.7. Apache, MySQL and PHP</h2></div></div></div>
    

    <p>If you plan to use Postfix Admin to manage your virtual users and
    domain, or provide webmail access to the email stored on the server you
    will have to install a web server.</p>

    <pre class="programlisting">apt-get install mysql-server mysql-client apache2 apache2-mpm-prefork apache2-utils ssl-cert \
                libapache2-mod-php5 php5 php5-common php5-curl php5-gd php-pear php5-imagick \
                php5-imap php5-mcrypt php5-mysql php5-pspell php5-sqlite php5-xmlrpc php5-xsl</pre>

    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      <p>This will also install Exim as the MTA. Uninstall it after you
      finish installing Postfix.</p>
    </div>

    <p>Default configuration of Apache sends server information in the
    response headers that we do not want to expose to everybody. To disable
    this open <code class="filename">/etc/apache2/conf.d/security</code> with nano and
    replace:</p>

    <pre class="programlisting">ServerTokens Full
ServerSignature On</pre>

    <p>with</p>

    <pre class="programlisting">ServerTokens Prod
ServerSignature Off</pre>

    <p>All application on my web server use UTF-8 as a default encoding so
    I also edit <code class="filename">/etc/apache2/conf.d/charset</code> and uncomment
    the <code class="computeroutput">AddDefaultCharset UTF-8</code> directive
    which adds the UTF-8 as the default charset to the header for all files
    that Apache sends to clients.</p>

    <p>PHP also provides additional information in the response headers so
    we can turn off those as well.</p>

    <p>Open <code class="filename">/etc/php5/apache2/php.ini</code> and change
    <code class="computeroutput">expose_php = On</code> to
    <code class="computeroutput">expose_php = Off</code>.</p>

    <p>Enable mod_rewrite in Apache and restart Apache for the changes to
    take effe</p>

    <pre class="programlisting">a2enmod rewrite
invoke-rc.d apache2 restart</pre>
  </div>
</div>

  <div class="chapter" title="Chapter 3. Security"><div class="titlepage"><div><div><h2 class="title"><a id="security"></a>Chapter 3. Security</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#security.certificates">3.1. Server certificates</a></span></dt><dt><span class="section"><a href="#security.firewall">3.2. Firewall</a></span></dt><dt><span class="section"><a href="#security.limiting-ssh">3.3. Limiting SSH access</a></span></dt><dt><span class="section"><a href="#security.intrusion-detection">3.4. Intrusion detection</a></span></dt></dl></div>
  

  <p>For securing our Debian box, we are going to use a firewall and an
  intrusion detection system called <span class="application">OSSEC</span>.</p>

  <p>We are also going to create server certificates which we will later
  use to secure communication coming to and from our server (emails,
  passwords, ...).</p>

  <div class="section" title="3.1. Server certificates"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="security.certificates"></a>3.1. Server certificates</h2></div></div></div>
    

    <p>First, we are goint to create a <span class="emphasis"><em>Private
    key</em></span>.</p>

    <pre class="screen"><code class="prompt">root@atlantis:~#</code> <span class="command"><strong>openssl genrsa -des3 -out server.key 1024</strong></span>
<code class="computeroutput">Generating RSA private key, 1024 bit long modulus
.............................................++++++
.............................................++++++
e is 65537 (0x10001)
Enter pass phrase for server.key:</code> <strong class="userinput"><code>your-password-here</code></strong></pre>

    <p>Now that we have a private key, we are going to create what is
    called a <a class="link" href="http://en.wikipedia.org/wiki/Certificate_signing_request" target="_top">Certificate
    Signing Request</a>.</p>

    <pre class="screen"><code class="prompt">root@atlantis:~#</code> <span class="command"><strong>openssl req -new -key server.key -out server.csr</strong></span>
<code class="computeroutput">Enter pass phrase for server.key:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:<strong class="userinput"><code>HR</code></strong>
State or Province Name (full name) [Some-State]:<strong class="userinput"><code>Grad Zagreb</code></strong>
Locality Name (eg, city) []:<strong class="userinput"><code>Zagreb</code></strong>
Organization Name (eg, company) [Internet Widgits Pty Ltd]:<strong class="userinput"><code>N/A</code></strong> 
Organizational Unit Name (eg, section) []:
Common Name (eg, YOUR name) []:<strong class="userinput"><code>atlantis.example.com</code></strong>
Email Address []:<strong class="userinput"><code>gog@example.com</code></strong>

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
</code></pre>

    <p>Make sure that the <code class="varname">Common</code> name matches your fully
    qualified domain name.</p>

    <p>Now we need to remove the passphrase from the key. If we do not do
    this, the server will ask you for the passphrase every time you reboot the
    service (Apache, Postfix or Courier).</p>

    <pre class="screen"><code class="prompt">root@atlantis:~#</code> <span class="command"><strong>cp server.key server.key.org</strong></span>
<code class="prompt">root@atlantis:~#</code> <span class="command"><strong>openssl rsa -in server.key.org -out server.key</strong></span>
<code class="computeroutput">Enter pass phrase for server.key.org:
writing RSA key</code>
</pre>

    <p><code class="filename">server.key</code> now does not contain a
    passphrase.</p>

    <p>Now, we are goint to create a self signed certificate. You can
    change the validity period from 365 days if you like.</p>

    <pre class="screen"><code class="prompt">root@atlantis:~#</code> <span class="command"><strong>openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt</strong></span>
<code class="computeroutput">Signature ok
subject=/C=HR/ST=Grad Zagreb/L=Zagreb/O=N/A/CN=atlantis.example.com/emailAddress=gog@example.com
Getting Private key
</code></pre>

    <p><code class="filename">server.crt</code> is the name of the self signed
    certificate.</p>

    <p>To create a <code class="filename">server.pem</code> file you need to
    concatenate <code class="filename">server.crt</code> and
    <code class="filename">server.key</code>.</p>

    <pre class="programlisting">cat server.crt server.key &gt; server.pem</pre>

    <p>Since <code class="filename">server.key</code> and
    <code class="filename">server.pem</code> contain a private server key without a
    passphrase you have to make sure regular users on your server can not
    access these files.</p>

    <p>You can store all of the files to <code class="filename">/root/keys</code> as
    we will need them later.</p>

    <pre class="screen"><code class="prompt">root@atlantis:~#</code> <span class="command"><strong>mkdir /etc/ssl/self-signed</strong></span>
<code class="prompt">root@atlantis:~#</code> <span class="command"><strong>mv server.* /etc/ssl/self-signed/</strong></span>
<code class="prompt">root@atlantis:~#</code> <span class="command"><strong>chown -R root:root /etc/ssl/self-signed/</strong></span>
<code class="prompt">root@atlantis:~#</code> <span class="command"><strong>chmod -R 644 /etc/ssl/self-signed/</strong></span>
</pre>

    <p>If you want to understand a little bit more about the whole process.
    Take a look <a class="link" href="http://www.akadia.com/services/ssh_test_certificate.html" target="_top">here</a>.</p>

    <p>Since we moved the keys to the <code class="filename">/etc</code> folder we
    should commit the changes.</p>

    <pre class="programlisting">etckeeper commit "Added server keys"</pre>
  </div>

  <div class="section" title="3.2. Firewall"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="security.firewall"></a>3.2. Firewall</h2></div></div></div>
    

    <p>We are going to secure our web server using iptables as a firewall.
    To make sure that are firewall rules are not lost when we reboot the
    server we are also going to install a package called
    <span class="application">iptables-persistent</span>.</p>

    <pre class="programlisting">apt-get install iptables iptables-persistent</pre>

    <p>If you check iptables rules with iptables -L you should see a clean
    chain list:</p>

    <pre class="screen"><code class="prompt">example:~#</code> <span class="command"><strong>iptables -L
</strong></span>Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination</pre>

    <p>To help us set up iptables rules we are going to use a modified
    version of a firewall script that is used for setting up QmailToaster on
    CentOS, the script looks like this:</p>

    <pre class="programlisting">#!/bin/sh
#
# Fedora Core 2
# Nick Hemmesch &lt;nick@ndhsoft.com&gt;
# June 2, 2004
#
# Customised for Debian/Ubuntu by Goran Juric, April 14, 2009.
 
## Set your IP address
MYIP="YOUR-IP-ADDRESS"
#ROUTER="IP-ADDRESS-THAT-BYPASSES-FIREWALL-RULES"
#
## Flush rules &amp; reset counters
iptables -F
iptables -X
#
## Set policies
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP
#
## Drop all incoming fragments
iptables -A INPUT -i eth0 -f -j DROP
#
## Drop outside packets with local addresses - anti-spoofing measure
iptables -A INPUT -s $MYIP -i ! lo -j DROP
iptables -A INPUT -s 127.0.0.0/8 -i ! lo -j DROP
iptables -A INPUT -s 10.0.0.0/8 -i ! lo -j DROP
iptables -A INPUT -s 192.168.0.0/16 -i ! lo -j DROP
iptables -A INPUT -s 224.0.0.0/4 -i ! lo -j DROP
iptables -A INPUT -s 0.0.0.0/8 -i ! lo -j DROP
iptables -A INPUT -s 255.255.255.255 -i ! lo -j DROP
iptables -A INPUT -s 169.254.0.0/16 -i ! lo -j DROP
iptables -A INPUT -s 221.240.102 -i ! lo -j DROP
iptables -A INPUT -s 203.215.94.193 -i ! lo -j DROP
iptables -A INPUT -s 218.71.137.68 -i ! lo -j DROP
#
## Pass all locally-originating packets
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT
#
## Accept ICMP ping echo requests
## (this allows other people to ping your machine, among other things),
iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
#
## Accept all traffic from a specific machine with IP specified in the ROUTER variable
# Traffic coming from the company router (address of the clients behind NAT)
<span class="emphasis"><em>#iptables -A INPUT -p tcp -m tcp --syn -s $ROUTER -j ACCEPT</em></span>
#
## Accept traffic on port p from a specific machine with IP x.x.x.x
## replace p with the desired port number, and replace x.x.x.x with
## the desired IP, then uncomment the line.
#iptables -A INPUT -p tcp -m tcp --syn -s x.x.x.x --dport p -j ACCEPT
#
## Accept ftp-data and ftp (ports 20 &amp; 21)
#iptables -A INPUT -p tcp -m tcp --syn --dport 20 -j ACCEPT
#iptables -A INPUT -p tcp -m tcp --syn --dport 21 -j ACCEPT
#
## Accept ssh (port 22)
#iptables -A INPUT -p tcp -m tcp --syn --dport 22 -j ACCEPT
#
## Accept telnet (port 23)
##iptables -A INPUT -p tcp -m tcp --syn --dport 23 -j ACCEPT
#
## Accept smtp (port 25 | 587)
#iptables -A INPUT -p tcp -m tcp --syn --dport 25 -j ACCEPT
#iptables -A INPUT -p tcp -m tcp --syn --dport 587 -j ACCEPT
#
## Accept dns (port 53)
#iptables -A INPUT -p udp -m udp -s 0/0 --dport 53 -d 0/0 -j ACCEPT
#iptables -A INPUT -p tcp -m tcp -s 0/0 --dport 53 -d 0/0 -j ACCEPT
#
## Accept http (port 80)
#iptables -A INPUT -p tcp -m tcp --syn --dport 80 -j ACCEPT
#
## Accept Subversion (port 3690)
#iptables -A INPUT -p tcp -m tcp --syn --dport 3690 -j ACCEPT
#
## Accept pop3 (port 110)
#iptables -A INPUT -p tcp -m tcp --syn --dport 110 -j ACCEPT
#
## Accept pop3s (port 995)
#iptables -A INPUT -p tcp -m tcp --syn --dport 995 -j ACCEPT
#
## Accept inbound identd (port 113)
#iptables -A INPUT -p tcp -m tcp --syn --dport 113 -j ACCEPT
## or you can reject and send back a TCP RST packet instead
#iptables -A INPUT -p tcp -m tcp --dport 113 -j REJECT --reject-with tcp-reset
#
## Accept imap (port 143)
#iptables -A INPUT -p tcp -m tcp --syn --dport 143 -j ACCEPT
## Accept imaps (port 993)
#iptables -A INPUT -p tcp -m tcp --syn --dport 993 -j ACCEPT
#
## Accept https (port 443)
#iptables -A INPUT -p tcp -m tcp --syn --dport 443 -j ACCEPT
#
## Accept smtps (port 465)
#iptables -A INPUT -p tcp -m tcp --syn --dport 465 -j ACCEPT
## Accept msp (port 587)
#iptables -A INPUT -p tcp -m tcp --syn --dport 587 -j ACCEPT
#
## Accept SpamAssassin (port 783)
#iptables -A INPUT -p tcp -m tcp --syn --dport 783 -j ACCEPT
#
## Accept pop3s (port 995)
#iptables -A INPUT -p tcp -m tcp --syn --dport 995 -j ACCEPT
#
## Accept mysql (port 3306)
#iptables -A INPUT -p tcp -m tcp --syn --dport 3306 -j ACCEPT
#
## Allow inbound established and related outside communication
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
#
## Drop outside initiated connections
iptables -A INPUT -m state --state NEW -j REJECT
#
## Allow all outbound tcp, udp, icmp traffic with state
iptables -A OUTPUT -p tcp -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p udp -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p icmp -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
 
## Save rules
#
#service iptables save#
iptables-save &gt; /etc/iptables/rules
#
echo ""
echo "Check your rules - iptables -L -n and move the iptables.rules to appropriate place"
echo ""</pre>

    <p>There are a couple of things that you have to modify in this
    script.</p>

    <p>First, and the most important one, is the <code class="varname">MYIP</code>
    variable that you should set to the IP address of your server.</p>

    <p>If you are always accessing the server from the same IP addres you
    can set that IP address to the variable called <code class="varname">ROUTER</code>
    and uncomment the line where this variable is defined as well as the line
    containing <code class="computeroutput">iptables -A INPUT -p tcp -m tcp --syn -s
    $ROUTER -j ACCEPT</code>.</p>

    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      <p>Be carefull setting the ROUTER variable</p>

      <p>This IP address will never be firewalled and all ports on the
      server will be open for this address. If you know what you are doing, by
      setting the <code class="varname">ROUTER</code> variable and allowing all traffic
      from that address, you will be able to close SSH port for everybody
      else.</p>
    </div>

    <p>If you do not have <code class="varname">ROUTER</code> variable set and
    appropriate lines uncommented you will have to uncomment the line with the
    rule that allows port 22 (SSH) to pass through. If you do not do this, you
    will lock yourself out of the system once we run the script (unless you
    are sitting and terminal and not accessing it remotely via SSH).</p>

    <div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
      <p>This is important</p>

      <p>Please do not run this script if you haven't read and understood
      the last couple of paragraphs. You could lock yourself out of the
      system.</p>
    </div>

    <p>Make the necessary modifications and save the script to
    <code class="filename">/root/scripts/firewall.sh</code>. Now we just have to make
    it executable and change it's ownership to the <code class="systemitem">root</code> user.</p>

    <pre class="programlisting">chown root:root /root/scripts/firewall.sh
chmod 700 /root/scripts/firewall.sh
chmod +x /root/scripts/firewall.sh</pre>

    <p>After the script is run it will save the information that is needed
    for the rules to be restored into
    <code class="filename">/etc/iptables/rules</code>. This file is used by
    <span class="application">iptables-persistent</span> to restore the rules if you
    reboot your server.</p>

    <p>As you have maybe notices all ports are closed for now. If you
    already have some services running on the server you will have to
    uncomment the appropriate lines and pass the traffic to the ports you
    need. It's time to finally run the script.</p>

    <pre class="programlisting">/root/scripts/firewall.sh</pre>

    <p>You will see some warning beacuse this is the script I have beed
    using on Debian Lenny, but rest assured you can safely ignore them. If you
    check your iptables rules you will see that they are fine.</p>

    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      <p>Opening up ports</p>

      <p>As we go through the installation of the mail server we will have
      to open up specific ports. When the time comes, this will be pointed out
      to you.</p>
    </div>

    <p>Commit the changes made to the firewall rules with etckeeper.</p>
  </div>

  <div class="section" title="3.3. Limiting SSH access"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="security.limiting-ssh"></a>3.3. Limiting SSH access</h2></div></div></div>
    

    <p>There are couple of things you can do to limit access to the SSH
    service on your system.</p>

    <p>If you have a static IP address that you want to use to accesss the
    server, setting the <code class="varname">ROUTER</code> variable in the firewall
    scripts is a good idea because the SSH port for everybody not coming from
    that address will be closed by the firewall.</p>

    <p>Other things you should consider:</p>

    <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
        <p>Disabling root login, installing <span class="application">sudo</span>
        and adding your username to the sudoers list.</p>
      </li><li class="listitem">
        <p>Changing SSH server to listen on a non standard port (default is
        22). Just remember to change your firewall rules.</p>
      </li><li class="listitem">
        <p>Disabling login via the use of passwords and use keys to login
        to your server.</p>
      </li><li class="listitem">
        <p>Use <a class="link" href="http://en.wikipedia.org/wiki/Port_knocking" target="_top">port
        knocking</a>.</p>
      </li></ol></div>
  </div>

  <div class="section" title="3.4. Intrusion detection"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="security.intrusion-detection"></a>3.4. Intrusion detection</h2></div></div></div>
    

    <p>For intrusion detection we are going to use a program called
    <span class="application">OSSEC</span>. If you want to find out more about OSSEC
    visit it's <a class="link" href="http://www.ossec.net/" target="_top">web site</a>.</p>

    <p>Although <span class="application">OSSEC</span> is not yet available in
    Debians repositories the good news is that OSSECs installer is "Debian
    aware" and it will create appropriate init scripts for OSSEC.</p>

    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      <p>During the installation OSSEC checks the available files in the
      /var/log folder and adds them to the list of files that should be
      monitored. If you install OSSEC before installing all other services on
      your server some of the log files will not be monitored unless you add
      them manually to OSSECs configuration.</p>

      <p>Also, OSSEC will not be able to send out emails untill you finish
      setting up the mail server.</p>
    </div>

    <p>Download the latest release of OSSEC from its we biste. At the time
    of writing the latest release is 2.5.1</p>

    <pre class="programlisting">mkdir /root/src
cd /root/src
wget http://www.ossec.net/files/ossec-hids-latest.tar.gz</pre>

    <div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
      <p>Do not skip cheksum checking</p>

      <p>On the web site you will also find a list of checksum for the
      release you just downloaded. Before proceeding any further you should
      check that the cheksums published on the web site, are the some ones you
      are getting for the file you just downloaded. Do this using the
      <span class="application">md5sum</span> and <span class="application">sha1sum</span>
      utilities.</p>
    </div>

    <pre class="screen"><code class="prompt">root@atlantis:~/src#</code> <span class="command"><strong>sha1sum ossec-hids-2.5.1.tar.gz</strong></span> 
<code class="computeroutput">6dbda038020b30ff4f115fe655f69c4d9ae01994  ossec-hids-2.5.1.tar.gz</code>
<code class="prompt">root@atlantis:~/src#</code> <span class="command"><strong>md5sum ossec-hids-2.5.1.tar.gz</strong></span>
<code class="computeroutput">94a7cabbba009728510a7a3e290ab200  ossec-hids-2.5.1.tar.gz</code></pre>

    <p>Now we need to extract the files from the downloaded archive.</p>

    <pre class="programlisting">tar -xvzf ossec-hids-2.5.1.tar.gz
</pre>

    <p>Since the installer will compile OSSEC we need to have a compiler
    and a <span class="application">make</span> utility installed on our
    system.</p>

    <pre class="programlisting">apt-get install gcc make</pre>

    <p>Run the installation script</p>

    <pre class="programlisting">cd ossec-hids-2.5.1
./install.sh</pre>

    <p>During the installation you will have to select set some
    options:</p>

    <div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
        <p>Select the language for the installation</p>
      </li><li class="listitem">
        <p>What kind of installation do you want (server, agent, local or
        help)? <strong class="userinput"><code>local</code></strong></p>
      </li><li class="listitem">
        <p>Choose where to install the OSSEC HIDS [/var/ossec]:
        <strong class="userinput"><code>/var/ossec</code></strong></p>
      </li><li class="listitem">
        <p>Do you want e-mail notification? (y/n) [y]:
        <strong class="userinput"><code>y</code></strong></p>
      </li><li class="listitem">
        <p>What's your e-mail address?
        <strong class="userinput"><code>your-email@example.com</code></strong></p>
      </li><li class="listitem">
        <p>What's your SMTP server ip/host?
        <strong class="userinput"><code>localhost</code></strong></p>
      </li><li class="listitem">
        <p>Do you want to run the integrity check daemon? (y/n) [y]:
        <strong class="userinput"><code>y</code></strong></p>
      </li><li class="listitem">
        <p>Do you want to run the rootkit detection engine? (y/n) [y]:
        <strong class="userinput"><code>y</code></strong></p>
      </li><li class="listitem">
        <p>Do you want to enable active response? (y/n) [y]:
        <strong class="userinput"><code>y</code></strong></p>
      </li><li class="listitem">
        <p>Do you want to enable the firewall-drop response? (y/n) [y]:
        <strong class="userinput"><code>y</code></strong></p>
      </li><li class="listitem">
        <p>Do you want to add more IPs to the white list? (y/n)? [n]:
        <strong class="userinput"><code>y</code></strong></p>
      </li><li class="listitem">
        <p>IPs (space separated): <strong class="userinput"><code>IP address you do not want to
        get blocked</code></strong></p>
      </li></ol></div>

    <p>After we answer all of the questions the installer will compile
    <span class="application">OSSEC</span>, finish the installation and create init
    scripts that will start <span class="application">OSSEC</span> during
    boot.</p>

    <p>Now it is a good time to commit our changes to the <code class="filename">/etc</code> folder.</p>

    <pre class="programlisting">etckeeper commit "Installed OSSEC"</pre>

    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      <p>False positives</p>

      <p>You will probably start getting emails that you do not want to
      receive. Luckily, <span class="application">OSSEC</span> allows you to filter
      out those emails. For managing <span class="application">OSSEC</span> rules
      you will have to reffer to the <span class="application">OSSEC</span>
      documentation on their <a class="link" href="http://www.ossec.net/" target="_top">web
      site</a>.</p>
    </div>

    <p>You probably do not need a compiler on your server and not having
    one makes it harder to do damage if somebody gains access to your server.
    So we are going to remove gcc and make.</p>

    <pre class="programlisting">apt-get --purge remove gcc make
apt-get autoremove</pre>
  </div>
</div>

  <div class="chapter" title="Chapter 4. Mail server"><div class="titlepage"><div><div><h2 class="title"><a id="mail-server"></a>Chapter 4. Mail server</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#postfix">4.1. Postfix</a></span></dt><dd><dl><dt><span class="section"><a href="#postfix.inital-settings">4.1.1. Initial settings</a></span></dt><dt><span class="section"><a href="#postfix.virtual-users">4.1.2. Virtual users and domains</a></span></dt><dt><span class="section"><a href="#postfix.mysql">4.1.3. MySQL</a></span></dt><dt><span class="section"><a href="#postfix.sasl">4.1.4. Saslauthd</a></span></dt><dt><span class="section"><a href="#postfix.acl">4.1.5. Preventing unwanted access</a></span></dt><dt><span class="section"><a href="#postfix.tls">4.1.6. TLS</a></span></dt><dt><span class="section"><a href="#id36888137">4.1.7. Submission port</a></span></dt><dt><span class="section"><a href="#id36888170">4.1.8. Blocking certain attachments</a></span></dt><dt><span class="section"><a href="#id36888203">4.1.9. Maximum message size</a></span></dt><dt><span class="section"><a href="#id36888222">4.1.10. Commit your changes</a></span></dt><dt><span class="section"><a href="#id36888237">4.1.11. Important commands</a></span></dt></dl></dd><dt><span class="section"><a href="#courier">4.2. Courier</a></span></dt><dd><dl><dt><span class="section"><a href="#courier.installation">4.2.1. Installation</a></span></dt><dt><span class="section"><a href="#courier.certificates">4.2.2. Use certificates</a></span></dt><dt><span class="section"><a href="#courier.firewall-rules">4.2.3. Firewall rules</a></span></dt><dt><span class="section"><a href="#courier.commit-changes">4.2.4. Commit your changes</a></span></dt></dl></dd><dt><span class="section"><a href="#antispam">4.3. Fighting spam</a></span></dt><dd><dl><dt><span class="section"><a href="#antispam.clamav">4.3.1. ClamAV</a></span></dt><dt><span class="section"><a href="#antispam.spamassassin">4.3.2. SpamAssassin</a></span></dt><dt><span class="section"><a href="#antispam.amavis">4.3.3. Amavisd-new</a></span></dt><dt><span class="section"><a href="#antispam.dkim">4.3.4. DKIM</a></span></dt><dt><span class="section"><a href="#id36889377">4.3.5. RBL lists</a></span></dt><dt><span class="section"><a href="#antispam.greylisting">4.3.6. Greylisting</a></span></dt></dl></dd><dt><span class="section"><a href="#utilities">4.4. Utilities</a></span></dt><dd><dl><dt><span class="section"><a href="#utilities.maildrop">4.4.1. Maildrop</a></span></dt><dt><span class="section"><a href="#id36889545">4.4.2. Vacation</a></span></dt><dt><span class="section"><a href="#id36889820">4.4.3. Mailing lists</a></span></dt></dl></dd></dl></div>
  

  <p>We are going to install <span class="application">Postfix</span> as our MTA
  (SMTP server) and <span class="application">Courier</span> as our POP/IMAP server.
  <span class="application">Postfix</span> will use virtual domains, and information
  about our domains and users will be stored in the
  <span class="application">MySQL</span> database.</p>

  <p>For managing virtual domains and users we will use
  <span class="application">PostfixAdmin</span>. For virus scanning and spam
  protection of our emails we will use <span class="application">ClamAV</span> and
  <span class="application">Spamassassin</span> that will be run using
  <span class="application">amavisd-new</span>.</p>

  <p>As a local delivery agent we will use
  <span class="application">Maildrop</span> that will be configured to move all
  messages marked as spam to the Junk folder as well as to make sure that
  users do not go over their assigned quota.</p>

  <p>This implementation of quota on the mail system does not require you
  to patch Postfix.</p>

  <p>All software is installed from official Debian repositories.</p>

  <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
    <p>This tutorial is a combination of tutorials published on <a class="link" href="http://articles.slicehost.com/email" target="_top">http://articles.slicehost.com/email</a>
    and <a class="link" href="https://help.ubuntu.com/community/PostfixCompleteVirtualMailSystemHowto" target="_top">https://help.ubuntu.com/community/PostfixCompleteVirtualMailSystemHowto</a>
    and a lot of my own work. You also must have a valid MX record in the DNS
    zone of your domain pointing to the IP address of the server.</p>
  </div>

  <div class="section" title="4.1. Postfix"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="postfix"></a>4.1. Postfix</h2></div></div></div>
  

  <p>The time has finally come to install
  <span class="application">Postfix</span>.</p>

  <pre class="programlisting">apt-get install postfix</pre>

  <p>During installation Postfix will ask you to choose the type of
  installation and a domain.</p>

  <p>Choose <code class="computeroutput">Internet site</code> and enter your
  servers name <code class="computeroutput"><code class="systemitem">atlantis.example.com</code></code>. It
  is important that your server name is not just <code class="systemitem">example.com</code>.</p>

  <p>After installation finishes we can check if Postfix is runing by
  connecting to port 25 on your localhost with telnet:</p>

  <pre class="screen"># <span class="command"><strong>telnet</strong></span> localhost 25
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
220 atlantis.example.com ESMTP Postfix (Debian/GNU)</pre>

  <p>Type <span class="command"><strong>quit</strong></span> to exit.</p>

  <p>If you see Postfix responding, Postfix is working. For another check
  we can try to send email to one of your email accounts that are located on
  another server:</p>

  <a id="postfix.test-email-sending"></a><pre class="screen">atlantis:~# <span class="command"><strong>mail</strong></span> your-other-email@somedomain.com
Subject: test email from example.com
test body of the email.
.
Cc:</pre>

  <p>The single dot on the line is a sign that your are done with the
  emails body.</p>

  <p>You should be getting this email message on the account you
  specified.</p>

  <p>Check that you have your <code class="systemitem">example.com</code> in a file
  <code class="filename">/etc/mailname</code>.</p>

  <div class="section" title="4.1.1. Initial settings"><div class="titlepage"><div><div><h3 class="title"><a id="postfix.inital-settings"></a>4.1.1. Initial settings</h3></div></div></div>
    

    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      <p>Do not be afraid to play with config files at this stage. If you
      have installed <span class="application">etckeeper</span> <a class="link" href="#preparation.tracking-changes" title="2.2. Tracking configuration changes">as suggested</a>, you can
      always revert to the previous state. Just remember to commit your
      changes every time you change something by running <span class="command"><strong>etckeeper
      commit "Descirption of the changes made"</strong></span>. The default Postfix
      configuration files were already commited when we installed
      Postfix.</p>
    </div>

    <p>First we are going to delete the content of the
    <code class="filename">/etc/postfix/main.cf</code> file so we can fill it with our
    own.</p>

    <pre class="programlisting">atlantis:~# <span class="command"><strong>cat</strong></span> /dev/null &gt; /etc/postfix/main.cf</pre>

    <p>Now copy and paste these lines, but make sure to replace
    <span class="emphasis"><em>myhostname = atlantis.example.com</em></span> with your
    hostname.</p>

    <pre class="screen">##################
# Default settings
##################
biff = no
append_dot_mydomain = no
#delay_warning_time = 4h
readme_directory = no
smtpd_banner = $myhostname ESMTP $mail_name

################
# TLS parameters
################
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

###############
# Main settings
###############
myhostname = <em class="replaceable"><code>atlantis.example.com</code></em>
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = $mydomain, localhost.$mydomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all</pre>

    <div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3>
      <p>Postfix extracts $mydomain from the value of the
      <code class="varname">myhostname</code> and strips the part before the first dot,
      including the dot. So in this case <code class="varname">mydomain</code> is
      <span class="emphasis"><em>example.com</em></span>.</p>
    </div>

    <p>If you are not using IPv6 you can remove IPv6 addresses from
    <code class="varname">mynetworks</code> and leave just <span class="emphasis"><em>mynetworks =
    127.0.0.0/8</em></span>. We will use the <code class="varname">mynetworks</code>
    variable to tell Postfix that all computers specified in the my networks
    range can send emails without authentification. We are leaving only the
    localhost here so we make sure that mail originating from the server (like
    outputs of cron jobs and other system messages) do not get blocked by
    other rules we will implement.</p>

    <p>Restart Postfix by running <span class="command"><strong>invoke-rc.d postfix
    restart</strong></span> and try to send another test mail to check that we
    didn't mess something up.</p>

    <p>Now it would be a good time to also test if Postfix is receiving
    mails as well. Try sending an email to just <code class="email">&lt;<a class="email" href="mailto:root">root</a>&gt;</code> and to
    <code class="email">&lt;<a class="email" href="mailto:root@example.com">root@example.com</a>&gt;</code> using the <span class="command"><strong>mail</strong></span> command
    as described in the <a class="link" href="#postfix.test-email-sending">previous
    section</a>. If everything works the received emails should be located
    in <code class="filename">/var/mail/root</code>. Check that file and make sure that
    you are sending email from the right domain (sender should be
    <code class="email">&lt;<a class="email" href="mailto:root@example.com">root@example.com</a>&gt;</code>). If you do not receive an email check the
    Postifx log file <code class="email">&lt;<a class="email" href="mailto:/var/log/mail.log">/var/log/mail.log</a>&gt;</code> to see what could have
    gone wrong.</p>
  </div>

  <div class="section" title="4.1.2. Virtual users and domains"><div class="titlepage"><div><div><h3 class="title"><a id="postfix.virtual-users"></a>4.1.2. Virtual users and domains</h3></div></div></div>
    

    <p>Our current setup can only receive mail for for users that exist on
    our server (root, the one that you created druing the installation and
    other system users). As you can see this is not quite helpfull as we could
    only server one domain and all the users that have email addresses on that
    domain would have to be created on the server.</p>

    <p>To avoid all this we are going to use virtual domains and users.
    That means that we are going to create a couple of databases where we will
    store all the domains and users that we will be receiving mail for.</p>

    <p>First, we are going to create a system user which will have
    persmissions to read and write emails to the system as well as the
    directory for storing all of the mail.</p>

    <p>User will be called <code class="systemitem">vmail</code>
    and will have a group with ID 5000 on the system.</p>

    <pre class="programlisting"><span class="command"><strong>groupadd</strong></span> -g 5000 vmail
<span class="command"><strong>useradd</strong></span> -s /usr/sbin/nologin -g vmail -u 5000 vmail -d /home/vmail -m</pre>

    <p>The extra parameters for the <span class="command"><strong>useradd</strong></span> command tell
    the system that this user will not be able to log on to the system, that
    he belongs to group 5000 and that it's home folder is <code class="filename">/home/vmail</code>. This is the folder where all of
    the received messages will be stored.</p>
  </div>

  <div class="section" title="4.1.3. MySQL"><div class="titlepage"><div><div><h3 class="title"><a id="postfix.mysql"></a>4.1.3. MySQL</h3></div></div></div>
    

    <p>Install MySQL.</p>

    <pre class="programlisting">apt-get install postfix-mysql mysql-server</pre>

    <p>We are going to use <span class="application">Postfix Admin</span> for
    managing virtual users and domains. Download latest version of Postfix
    Admin and move the content of the archive to
    <code class="filename">/var/www/postfix</code>.</p>

    <pre class="programlisting">cd /root/src
wget LINK-TO-THE-LATEST-VERSION
tar -xvzf postfixadmin-2.3.2.tar.gz
mv postfixadmin-2.3.2 /var/www/postfix</pre>

    <p>Before installing Postfix Admin we must create a database and a user
    to access the database.</p>

    <pre class="programlisting">mysql -u root</pre>

    <p>If you have a password set use the <span class="command"><strong>-p</strong></span>
    flag.</p>

    <p>Once in MySQL:</p>

    <pre class="programlisting">CREATE DATABASE mail;
CREATE USER 'mailadmin'@'localhost' IDENTIFIED BY '<strong class="userinput"><code>newpassword</code></strong>';
GRANT ALL PRIVILEGES ON `mail` . * TO 'mailadmin'@'localhost';
FLUSH PRIVILEGES;</pre>

    <p>Of course you need to change the <strong class="userinput"><code>newpassword</code></strong>
    with your own password. You can exit MySQL by typing
    <span class="command"><strong>exit</strong></span>.</p>

    <p>Open <code class="filename">/var/www/postfix/config.inc.php</code> with nano.
    Set <code class="varname">$CONF['configured']</code> to <code class="literal">true</code>,
    choose your setup password, set
    <code class="varname">$CONF['postfix_admin_url']</code> to
    <code class="literal">http://SERVERS-IP-ADDRESS/postfix</code> and enter your
    database information and credentials.</p>

    <p>While you are at it, you should also go through all of the other
    options you can set in the config mail.</p>

    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      <p>To use Postfix Admin you must setup PHP and Apache as described
      <a class="link" href="#preparation.lamp" title="2.7. Apache, MySQL and PHP">here</a>.</p>
    </div>

    <p>Open up
    <code class="literal">http://SERVERS-IP-ADDRESS/postfix/setup.php</code> in your
    browser and finish the installation. Once logged in into the Postfix Admin
    create a new virtual domain <code class="systemitem">example.com</code>, and create new user accout
    username@example.com. Use your own domain name here.</p>

    <p>Postifx Admin created MySQL tables for us and now it is time to tell
    Postfix to use this tables to get information about email addresses and
    domains it should serve.</p>

    <p>First we need to create 4 files in the <code class="filename">/etc/postfix</code> folder.</p>

    <p><code class="filename">/etc/postfix/sql/virtual_alias_maps.cf</code></p>

    <pre class="screen">user = mailadmin
password = newpassword
hosts = 127.0.0.1
dbname = mail
table = alias
select_field = goto
where_field = address</pre>

    <p>/etc/postfix/sql/virtual_domains_maps.cf</p>

    <pre class="screen">user = mailadmin
password = newpassword
hosts = 127.0.0.1
dbname = mail
table = domain
select_field = domain
where_field = domain
additional_conditions = and backupmx = '0' and active = '1'</pre>

    <p><code class="filename">/etc/postfix/sql/virtual_mailbox_maps.cf
    </code></p>

    <pre class="screen">user = mailadmin
password = newpassword
hosts = 127.0.0.1
dbname = mail
table = mailbox
query = SELECT CONCAT(domain,'/',SUBSTRING_INDEX(maildir,'@',1),'/') FROM mailbox WHERE username='%s' AND active = 1</pre>

    <p><code class="filename">/etc/postfix/sql/relay_domains_maps.cf</code></p>

    <pre class="screen">user = mailadmin
password = newpassword
hosts = 127.0.0.1
dbname = mail
table = domain
select_field = domain
where_field = domain
additional_conditions = and backupmx = '1'</pre>

    <p>As you can see, these files containt information that Postfix uses
    to fetch data from the database.</p>

    <p>Since these files contain passwords, we need to protect them:</p>

    <pre class="programlisting"><code class="prompt">root@atlantis:~#</code> <span class="command"><strong>cd /etc/postfix/sql</strong></span>
<code class="prompt">atlantis:/etc/postfix/sql#</code> <span class="command"><strong>chgrp postfix *</strong></span>
<code class="prompt">atlantis:/etc/postfix/sql#</code> <span class="command"><strong>chmod 640 *</strong></span></pre>

    <p>Edit <code class="filename">/etc/postfix/main.cf</code> and at the bottom of
    the file add</p>

    <pre class="screen">##################
# Virtual Settings
##################
virtual_mailbox_base = /home/vmail
virtual_transport = virtual
virtual_alias_maps = mysql:/etc/postfix/sql/virtual_alias_maps.cf
virtual_mailbox_domains = mysql:/etc/postfix/sql/virtual_domains_maps.cf
virtual_mailbox_maps = mysql:/etc/postfix/sql/virtual_mailbox_maps.cf
virtual_minimum_uid = 5000
virtual_uid_maps = static:5000
virtual_gid_maps = static:5000

# Domains for which we are a secondary MX
relay_domains = mysql:/etc/postfix/sql/relay_domains_maps.cf</pre>

    <p>You also need to delete everything in the
    <code class="varname">mydestination</code> directive because every domain that is
    entered in the mydestionation is treated as a “local” domain so the mail
    gets delivered to the local server users and it is located in
    <code class="filename">/var/spool/mail</code>.</p>

    <p>Restart Postfix.</p>

    <pre class="programlisting">invoke-rc.d postfix restart</pre>

    <p>Now it's time to check if everything is working as expects. Send a
    test email to the email address you have created using Postfix Admin.
    Check your <code class="filename">/home/vmail/example.com/username</code> folder.
    There should be 3 folders inside : <code class="filename">cur</code>,
    <code class="filename">new</code> and <code class="filename">tmp</code>. Inside the folder
    <code class="filename">new</code> you should see your email message. If this didn't
    work, check <code class="filename">/var/log/mail.log</code> for possible hints on
    what went wrong.</p>

    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      <p>Since our system is now ready to receive email from the outside
      world you can uncomment the line that blocks port 25 in the
      <code class="filename">firewall.sh</code> script and run the script again.</p>
    </div>
  </div>

  <div class="section" title="4.1.4. Saslauthd"><div class="titlepage"><div><div><h3 class="title"><a id="postfix.sasl"></a>4.1.4. Saslauthd</h3></div></div></div>
    

    <p>Since we want to allow users to log in to our mail server so they
    can send emails, we need to configure some kind of protection. First we
    need to make sure users can log in using the same username and password as
    the one they will be using for checking email.</p>

    <p>For this, we are going to use <span class="application">Saslauthd</span>.
    Saslauthd will also use the same database we already created to verify
    user credentials.</p>

    <pre class="programlisting">apt-get install libsasl2-2 libsasl2-modules libsasl2-modules-sql sasl2-bin libpam-mysql</pre>

    <p>Open <code class="filename">/etc/default/saslauthd</code> with nano and
    change <code class="computeroutput">START=no</code> to
    <code class="computeroutput">START=yes</code>. At the end of the file we need
    to change <code class="computeroutput">OPTIONS=”-c -m
    /var/run/saslauthd”</code> to</p>

    <pre class="programlisting">OPTIONS="-c -r -m /var/spool/postfix/var/run/saslauthd"</pre>

    <p>We also need to create this directory</p>

    <pre class="programlisting">mkdir -p /var/spool/postfix/var/run/saslauthd</pre>

    <p>and one symbolic link (because Postfix on Debian is running from a
    chrooted environment and other applications you maybe using on your server
    (including testsaslauthd for testing if saslauthd is working correctly)
    are not aware of us changing the saslauthd directory).</p>

    <pre class="programlisting">rm -rf /var/run/saslauthd
ln -s /var/spool/postfix/var/run/saslauthd /var/run/saslauthd</pre>

    <div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
      <p>If you do not delete <code class="filename">/var/run/saslauthd</code>
      before creating a symbolic link the link will we created in
      <code class="filename">/var/run/saslauthd/saslauthd</code> and testing SASL with
      <span class="application">testsaslauthd</span> will result in an error:
      "<code class="computeroutput">connect() : No such file or directory
      0</code>".</p>
    </div>

    <p>We also need to create two more files:</p>

    <pre class="programlisting">nano /etc/pam.d/smtp</pre>

    <pre class="screen">auth    required   pam_mysql.so user=mailadmin passwd=newpassword host=127.0.0.1 db=mail table=mailbox usercolumn=username passwdcolumn=password crypt=1
account sufficient pam_mysql.so user=mailadmin passwd=newpassword host=127.0.0.1 db=mail table=mailbox usercolumn=username passwdcolumn=password crypt=1</pre>

    <pre class="programlisting">nano /etc/postfix/sasl/smtpd.conf</pre>

    <pre class="screen">pwcheck_method: saslauthd
mech_list: plain login
allow_plaintext: true
auxprop_plugin: mysql
sql_hostnames: 127.0.0.1
sql_user: mailadmin
sql_passwd: newpassword
sql_database: mail
sql_select: select password from mailbox where username = '%u' and active = '1'</pre>

    <p>We need to add Postfix to the sasl group so it can access the
    saslauthd process we just created:</p>

    <pre class="programlisting">adduser postfix sasl</pre>

    <p>Restart Postfix and sasl</p>

    <pre class="screen">/etc/init.d/postfix restart
/etc/init.d/saslauthd restart</pre>

    <p>Now, we can check is saslauthd is working correctly.</p>

    <pre class="programlisting">testsaslauthd -s smtp -u root@example.com -p newpassword</pre>

    <p>Ofcourse use your own credentials here. Authentification should
    work.</p>

    <pre class="screen">atlantis:~# testsaslauthd -s smtp -u root@example.com -p newpassword
0: OK "Success."</pre>

    <p>If you do not get “Success.” as a response, check that you have a
    symbolic link in <code class="filename">/var/run/</code> named
    <code class="filename">saslauthd</code> and that it points to
    <code class="filename">/var/spool/postfix/var/run/saslautdh</code>.</p>

    <p>We have to change permissions to these two files as well:</p>

    <pre class="programlisting">chgrp sasl /etc/pam.d/smtp
chmod 640 /etc/pam.d/smtp
chgrp postfix /etc/postfix/sasl/smtpd.conf
chmod 640 /etc/postfix/sasl/smtpd.conf</pre>

    <p>We also need to tell Postfix to allow authenticated users to send
    mail. Edit <code class="filename">/etc/postfix/main.cf</code> and add</p>

    <pre class="screen">smtpd_sender_restrictions =
    permit_mynetworks
    permit_sasl_authenticated
    permit_tls_clientcerts</pre>

    <p>Restart Postfix and sasl.</p>

    <pre class="programlisting">/etc/init.d/postfix restart
/etc/init.d/saslauthd restart</pre>
  </div>

  <div class="section" title="4.1.5. Preventing unwanted access"><div class="titlepage"><div><div><h3 class="title"><a id="postfix.acl"></a>4.1.5. Preventing unwanted access</h3></div></div></div>
    

    <p>To make sure our mail server is not used as an open relay, we will
    also add <code class="computeroutput">smtpd_recipient_restrictions</code> to
    <code class="filename">main.cf</code>:</p>

    <pre class="screen">smtpd_recipient_restrictions =
    permit_mynetworks
    permit_sasl_authenticated 
    reject_unauth_destination
    reject_unlisted_recipient
    reject_unverified_recipient</pre>

    <p>You need to restart Postfix once again. After setting this up you
    should <a class="link" href="http://www.mailradar.com/openrelay/" target="_top">check if your
    mail server can be used as an open relay</a>. If you have installed
    OSSEC for intrusion detection don't worry if the test don't finish because
    OSSECs active response blocks hosts that try to abuse your server (like
    the open relay test tool).</p>
  </div>

  <div class="section" title="4.1.6. TLS"><div class="titlepage"><div><div><h3 class="title"><a id="postfix.tls"></a>4.1.6. TLS</h3></div></div></div>
    

    <p>Now, we are going to configure Postfix to use TLS. If you still
    haven't created a <a class="link" href="#security.certificates" title="3.1. Server certificates">self signed
    certificates do it now</a>.</p>

    <pre class="programlisting">apt-get install postfix-tls</pre>

    <p>Edit <code class="filename">/etc/postfix/main.cf</code> and look for the part
    containing</p>

    <pre class="screen">smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache</pre>

    <p>and replace it with</p>

    <pre class="screen">smtpd_sasl_auth_enable = yes
broken_sasl_auth_clients = yes
smtpd_sasl_authenticated_header = yes
smtpd_recipient_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination
smtpd_use_tls = yes
smtpd_tls_cert_file = /etc/ssl/self-signed/server.pem
smtpd_tls_key_file = $smtpd_tls_cert_file</pre>

    <p>We are telling Postfix that we want to allow sending emails without
    authentication for our networks (localhost) and for users that
    authenticated using sasl we configured previously.</p>

    <p>Restart Postfix and try to send an email using your email client
    from your workstation. You will not be able to read emails yet. Just make
    sure that username you are using is your full email address, that you've
    selected to use authentication for your SMTP server and that TLS is
    selected.</p>
  </div>

  <div class="section" title="4.1.7. Submission port"><div class="titlepage"><div><div><h3 class="title"><a id="id36888137"></a>4.1.7. Submission port</h3></div></div></div>
    

    <p>Many ISPs today block port 25 for users. To be able to send email
    using our Postfix mail server as our outgoing server, we need to enable
    submission port (port 587) in Postfix and change the firewall rules to
    allow traffic to port 587.</p>

    <p>Open <code class="filename">/etc/postfix/master.cf</code> and uncomment the
    folloging lines:</p>

    <pre class="screen">submission inet n       -       -       -       -       smtpd
  -o smtpd_tls_security_level=encrypt
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_client_restrictions=permit_sasl_authenticated,reject
  -o milter_macro_daemon_name=ORIGINATING</pre>

    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      <p>Spaces in the lines after the first line are important. Do not
      delete them!</p>
    </div>
  </div>

  <div class="section" title="4.1.8. Blocking certain attachments"><div class="titlepage"><div><div><h3 class="title"><a id="id36888170"></a>4.1.8. Blocking certain attachments</h3></div></div></div>
    

    <p>To block certain extensions of attachments (.exe, .bat, …) edit
    <code class="filename">/etc/postfix/main.cf</code> and add</p>

    <pre class="screen">mime_header_checks = regexp:/etc/postfix/mime_header_checks</pre>

    <p>Create <code class="filename">/etc/postfix/mime_header_checks</code> and
    insert</p>

    <pre class="screen">/name=[^&gt;]*\.(bat|com|exe|dll|vbs)$/ REJECT</pre>

    <p>This will block all emails containg attachments that and in bat,
    com, exe, dll and vbs. Feel free to add other extension if you
    want.</p>
  </div>

  <div class="section" title="4.1.9. Maximum message size"><div class="titlepage"><div><div><h3 class="title"><a id="id36888203"></a>4.1.9. Maximum message size</h3></div></div></div>
    

    <p>Default maximum size of the message is 10240000 bytes (10 MB), to
    change this to 20MB edit <code class="filename">/etc/postfix/main.cf</code> and
    add</p>

    <pre class="screen">message_size_limit = 20480000</pre>
  </div>

  <div class="section" title="4.1.10. Commit your changes"><div class="titlepage"><div><div><h3 class="title"><a id="id36888222"></a>4.1.10. Commit your changes</h3></div></div></div>
    

    <p>If you are using etckeeper now is a good time to commit the changes
    you made.</p>

    <pre class="programlisting">etckeeper commit "Configured Postfix"</pre>
  </div>

  <div class="section" title="4.1.11. Important commands"><div class="titlepage"><div><div><h3 class="title"><a id="id36888237"></a>4.1.11. Important commands</h3></div></div></div>
    

    <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
        <p><span class="command"><strong>postconf mail_version</strong></span> - Find out what Postfix
        Version is installed</p>
      </li><li class="listitem">
        <p><span class="command"><strong>mailq</strong></span> - Show Mail Queue</p>
      </li><li class="listitem">
        <p><span class="command"><strong>postsuper -d ALL</strong></span> - Remove bounced mail from
        the queue</p>
      </li><li class="listitem">
        <p><span class="command"><strong>postfix flush</strong></span> - Flush the Mail Queue</p>
      </li></ul></div>

    <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
        <p><span class="command"><strong>postfix check</strong></span> - Check Installation</p>
      </li></ul></div>
  </div>
</div>
  <div class="section" title="4.2. Courier"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="courier"></a>4.2. Courier</h2></div></div></div>
  

  <p>For now, our server can receive emails, but we have no way of
  accessing those emails from a mail client. For this we are going to use
  <span class="application">Courier</span> as our IMAP and POP server.</p>

  <p><span class="application">Dovecot</span> is another popular option, but for
  this integration you will have to look elsewhere. For me, Dovecot is not an
  option because it does not automatically check for new mail in all of the
  IMAP folder when you select <code class="option">Get Mail</code> option in your mail
  client. And since all of the emails marked as <span class="emphasis"><em>Spam</em></span> is
  moved automatically to a <code class="filename">Junk</code> folder my client would
  not report to me if there are any new messages in the
  <code class="filename">Junk</code> folder unless I explicitly check for them. </p>

  <div class="section" title="4.2.1. Installation"><div class="titlepage"><div><div><h3 class="title"><a id="courier.installation"></a>4.2.1. Installation</h3></div></div></div>
    

    <pre class="programlisting">apt-get install courier-authdaemon courier-authlib-mysql courier-pop courier-pop-ssl courier-imap courier-imap-ssl</pre>

    <p>If you do not want to use POP you can skip installing packages that
    provide POP and install only</p>

    <pre class="programlisting">apt-get install courier-authdaemon courier-authlib-mysql courier-imap courier-imap-ssl</pre>

    <p>When asked if you would like to create directories for web-based
    administration, answer <strong class="userinput"><code>No</code></strong>.</p>

    <p>Open <code class="filename">/etc/courier/authdaemonrc</code> and
    change</p>

    <pre class="screen">authmodulelist="authpam"</pre>

    <p>to</p>

    <pre class="screen">authmodulelist="authmysql"</pre>

    <p>Empty <code class="filename">/etc/courier/authmysqlrc</code> and paste the
    following (change you password.</p>

    <pre class="screen">MYSQL_SERVER localhost
MYSQL_USERNAME mailadmin
MYSQL_PASSWORD <strong class="userinput"><code>newpassword</code></strong>
MYSQL_PORT 0
MYSQL_DATABASE mail
MYSQL_USER_TABLE mailbox
MYSQL_CRYPT_PWFIELD password
MYSQL_UID_FIELD 5000
MYSQL_GID_FIELD 5000
MYSQL_LOGIN_FIELD username
MYSQL_HOME_FIELD "/home/vmail"
MYSQL_MAILDIR_FIELD CONCAT(SUBSTRING_INDEX(username,'@',-1),'/',SUBSTRING_INDEX(username,'@',1),'/')
MYSQL_QUOTA_FIELD concat(quota,'S')</pre>

    <p>Notice that the QUOTE_FIELD has an “S” appended to the value. This
    is because Postfix Admin stores MailDir quota as an integer, and Courier
    maildrop expects the quota value to be in the format XXXS, where XXX
    represent the number of bytes that can be stored in the Maildir, and “S”
    stands for size. </p>

    <p>Maildrop can also use XXXC, where “C” I guess stands for “COUNT”
    because this value stands for number of messages that MailDir can
    store.</p>
  </div>

  <div class="section" title="4.2.2. Use certificates"><div class="titlepage"><div><div><h3 class="title"><a id="courier.certificates"></a>4.2.2. Use certificates</h3></div></div></div>
    

    <p>Edit <code class="filename">/etc/courier/imapd-ssl</code> and change the
    values of <code class="varname">TLS_CERTFILE</code> and
    <code class="filename">TLS_TRUSTCERTS</code> to </p>

    <pre class="screen">TLS_CERTFILE=/etc/ssl/self-signed/server.pem
TLS_TRUSTCERTS=/etc/ssl/self-signed/server.crt</pre>

    <p>To restart Courier you have to restart couple of services.</p>

    <pre class="screen">/etc/init.d/courier-authdaemon restart
/etc/init.d/courier-imap restart
/etc/init.d/courier-imap-ssl restart</pre>

    <p>And if you have it installed POP3 you need to restart those as
    well.</p>

    <pre class="screen">/etc/init.d/courier-pop restart
/etc/init.d/courier-pop-ssl restart</pre>

    <p>If you would like users of every virtual domain on your server to
    connect to <code class="systemitem">mail.their-domain.com</code> instead of to
    <code class="systemitem">atlantis.example.com</code> you
    will have to sign new certificates for every domain and also use a
    separate IP address for each virtual host. Information on placing
    certificates for various hosts can be found in
    <code class="filename">/etc/courier/imapd-ssl</code>. </p>
  </div>

  <div class="section" title="4.2.3. Firewall rules"><div class="titlepage"><div><div><h3 class="title"><a id="courier.firewall-rules"></a>4.2.3. Firewall rules</h3></div></div></div>
    

    <p>You have to change Firewall rules to allow inbound connections to
    ports that Courier uses:</p>

    <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
        <p>Pop and secure Pop use ports 110 and 995 respectively.</p>
      </li><li class="listitem">
        <p>Imap and secure imap use ports 143 and 993 respectively.</p>
      </li></ul></div>
  </div>

  <div class="section" title="4.2.4. Commit your changes"><div class="titlepage"><div><div><h3 class="title"><a id="courier.commit-changes"></a>4.2.4. Commit your changes</h3></div></div></div>
    

    <p>If you are using etckeeper now is a good time to commit the changes
    you made.</p>

    <pre class="programlisting">etckeeper commit "Configured Courier"</pre>
  </div>
</div>
  <div class="section" title="4.3. Fighting spam"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="antispam"></a>4.3. Fighting spam</h2></div></div></div>
  

  <p>Amavisd-new is a program that receives mail from Postfix, passes it
  through SpamAssassin and ClamAV and based on the user (or global) settings
  decides if the mail should be flagged as a spam, deleted or delivered as a
  legitimate mail.</p>

  <p>We are going to install all of the packages at once.</p>

  <pre class="programlisting">apt-get install amavisd-new spamassassin clamav-daemon</pre>

  <div class="section" title="4.3.1. ClamAV"><div class="titlepage"><div><div><h3 class="title"><a id="antispam.clamav"></a>4.3.1. ClamAV</h3></div></div></div>
    

    <p>ClamAV needs some utilities that are not provided in the mail Debian
    repository. This utillities will be used to extract email attachments so
    the content of the archives can be scanned for potential viruses.</p>

    <p>Because of this utillites we need to add
    <span class="emphasis"><em>contrib</em></span> and <span class="emphasis"><em>non-free</em></span>
    repositories to the <code class="filename">/etc/apt/sources.list</code>. To do this
    you have to append ”<code class="computeroutput">contrib non-free</code>” on
    every line that starts with deb, and ends with main. Your
    <code class="filename">/etc/apt/sources.list</code> file should look like
    this:</p>

    <pre class="screen">deb http://ftp2.de.debian.org/debian/ squeeze main contrib non-free
deb-src http://ftp2.de.debian.org/debian/ squeeze main

deb http://security.debian.org/ squeeze/updates main contrib non-free
deb-src http://security.debian.org/ squeeze/updates main

deb http://ftp2.de.debian.org/debian/ squeeze-updates main contrib non-free
deb-src http://ftp2.de.debian.org/debian/ squeeze-updates main</pre>

    <p>After editing <code class="filename">/etc/apt/sources.list</code> commit the
    changes you made to <code class="filename">sources.list</code> with etckeeper. Now
    we need to update the apt database. While we are at it we can also check
    if there are any packages that should be updated.</p>

    <pre class="programlisting">apt-get update
apt-get upgrade</pre>

    <p>Now we are ready to install utilities for decompression of
    archives.</p>

    <pre class="programlisting">apt-get install arj bzip2 cabextract cpio file gzip lha nomarch pax rar unrar unzip zip zoo</pre>

    <p>Add clamav user to the amavis group and vice versa in order for
    Clamav to have access to scan files:</p>

    <pre class="programlisting">adduser clamav amavis
adduser amavis clamav</pre>

    <p>Restart amavis and clamav-daemon.</p>

    <pre class="programlisting">/etc/init.d/clamav-daemon restart
/etc/init.d/amavis restart</pre>
  </div>

  <div class="section" title="4.3.2. SpamAssassin"><div class="titlepage"><div><div><h3 class="title"><a id="antispam.spamassassin"></a>4.3.2. SpamAssassin</h3></div></div></div>
    

    <p>Both SpamAssassin and amavisd-new are Perl programs, and amavisd-new
    includes SpamaAssassins libraries so it doesn't need SpamAssassin daemon
    running on the server. We are going to turn off the daemon and prevent it
    from starting up during boot.</p>

    <pre class="programlisting">/etc/init.d/spamassassin stop
update-rc.d -f spamassassin remove
etckeeper commit "Removed spamassassin from rcX.d"</pre>

    <p>To enable DKIM checking of received emails in SpamAssassin one has
    to install Mail::DKIM Perl library.</p>

    <pre class="programlisting">apt-get install libmail-dkim-perl</pre>

    <p>Edit <code class="filename">/etc/spamassassin/v312.pre</code> and check that
    this line is uncommented:</p>

    <pre class="screen">loadplugin Mail::SpamAssassin::Plugin::DKIM</pre>

    <p>We are also going to install Pyzor and Razor for additional
    checks.</p>

    <pre class="programlisting">apt-get install pyzor razor</pre>

    <p>After that you can try running SpamAssassing manually:</p>

    <pre class="programlisting">spamassassin -D -t &lt; /usr/share/doc/spamassassin/examples/sample-spam.txt 2&gt;&amp;1 | tee sa.out</pre>

    <p>You should see DKIM mentioned in the sa.out file, and the end of the
    output should look something like this:</p>

    <pre class="screen">Content analysis details:   (1004.5 points, 5.0 required)

 pts rule name              description
---- ---------------------- --------------------------------------------------
-0.0 NO_RELAYS              Informational: message was not relayed via SMTP
1000 GTUBE                  BODY: Generic Test for Unsolicited Bulk Email
 0.4 RAZOR2_CF_RANGE_51_100 Razor2 gives confidence level above 50%
                            [cf: 100]
 0.5 RAZOR2_CF_RANGE_E4_51_100 Razor2 gives engine 4 confidence level
                            above 50%
                            [cf: 100]
 1.7 RAZOR2_CHECK           Listed in Razor2 (http://razor.sf.net/)
 2.0 PYZOR_CHECK            Listed in Pyzor (http://pyzor.sf.net/)
 0.0 DIGEST_MULTIPLE        Message hits more than one network digest check
-0.0 NO_RECEIVED            Informational: message has no Received headers</pre>

    <div class="section" title="4.3.2.1. Training SpamAssassin"><div class="titlepage"><div><div><h4 class="title"><a id="antispam.spamassassin.training"></a>4.3.2.1. Training SpamAssassin</h4></div></div></div>
      

      <p>Bayes filtering is a strong weapon for fighting spam. It works by
      learning what is spam to you and what isn't. For SpamAssassing to start
      using Bayes filtering you have to train it first. Training your Bayes
      filters is something that you should do on a regular basis. The more
      emails it process the smarter it gets.</p>

      <p>To learn SpamAssassin what is spam, you have to use the sa-learn
      utillity on a folder where your spam messages are stored (in my case the
      folder is called <code class="filename">Junk</code>).</p>

      <p>Because SpamAssassin is run by amavisd-new you have to run the
      sa-learn utility as the amavis user.</p>

      <pre class="programlisting">su amavis sa-learn --no-sync --spam /home/vmail/example.com/demo/.Junk/cur</pre>

      <p>To learn what is not spam run sa-learn in the folder that only
      contains your non-spam mail (in this case, sa-learn examines the
      <code class="filename">Inbox</code> folder).</p>

      <pre class="programlisting">su amavis sa-learn --no-sync --ham /home/vmail/example.com/demo/cur</pre>

      <p>Bayes filtering will be used once you train SpamAssassin on more
      than 200 spam <span class="emphasis"><em>and</em></span> ham messages.</p>

      <p>To update SpamAssassin you can run:</p>

      <pre class="programlisting">sa-update -D</pre>

      <p><code class="computeroutput">-D</code> is for debug.</p>
    </div>

    <div class="section" title="4.3.2.2. Move Bayes data to MySQL"><div class="titlepage"><div><div><h4 class="title"><a id="antispam.spamassassin.bayes-mysql"></a>4.3.2.2. Move Bayes data to MySQL</h4></div></div></div>
      

      <p>TODO</p>
    </div>
  </div>

  <div class="section" title="4.3.3. Amavisd-new"><div class="titlepage"><div><div><h3 class="title"><a id="antispam.amavis"></a>4.3.3. Amavisd-new</h3></div></div></div>
    

    <p>Edit <code class="filename">/etc/amavis/conf.d/15-content_filter_mode</code>
    and ucomment antivirus and spam checking</p>

    <pre class="screen">use strict;

# You can modify this file to re-enable SPAM checking through spamassassin
# and to re-enable antivirus checking.

#
# Default antivirus checking mode
# Uncomment the two lines below to enable it back
#

@bypass_virus_checks_maps = (
   \%bypass_virus_checks, \@bypass_virus_checks_acl, \$bypass_virus_checks_re);


#
# Default SPAM checking mode
# Uncomment the two lines below to enable it back
#

@bypass_spam_checks_maps = (
   \%bypass_spam_checks, \@bypass_spam_checks_acl, \$bypass_spam_checks_re);

1;  # ensure a defined return
</pre>

    <p>To integrate Amavis with Postfix we need to add a content_filter in
    <code class="filename">/etc/postfix/main.cf</code>.</p>

    <pre class="programlisting">content_filter = smtp-amavis:[127.0.0.1]:10024</pre>

    <p>Open <code class="filename">/etc/postfix/master.cf</code> and add this at the
    end of the file:</p>

    <pre class="screen">smtp-amavis     unix    -       -       -       -       2       smtp
        -o smtp_data_done_timeout=1200
        -o smtp_send_xforward_command=yes
        -o disable_dns_lookups=yes
        -o max_use=20

127.0.0.1:10025 inet    n       -       -       -       -       smtpd
        -o content_filter=
        -o local_recipient_maps=
        -o relay_recipient_maps=
        -o smtpd_restriction_classes=
        -o smtpd_delay_reject=no
        -o smtpd_client_restrictions=permit_mynetworks,reject
        -o smtpd_helo_restrictions=
        -o smtpd_sender_restrictions=
        -o smtpd_recipient_restrictions=permit_mynetworks,reject
        -o smtpd_data_restrictions=reject_unauth_pipelining
        -o smtpd_end_of_data_restrictions=
        -o mynetworks=127.0.0.0/8
        -o smtpd_error_sleep_time=0
        -o smtpd_soft_error_limit=1001
        -o smtpd_hard_error_limit=1000
        -o smtpd_client_connection_count_limit=0
        -o smtpd_client_connection_rate_limit=0
        -o receive_override_options=no_header_body_checks,no_unknown_recipient_checks</pre>

    <p>and add this immediately below the “pickup” transport
    service:</p>

    <pre class="screen">         -o content_filter=
         -o receive_override_options=no_header_body_checks</pre>

    <p>This will prevent messages that are generated to report on spam from
    being classified as spam.</p>

    <p>Amavisd-new listens on port 1024 where Postfix sends all of the mail
    coming into the server. After processing the email amavisd-new returns the
    mail to Postfix on port 1025 for final delivery.</p>

    <p>Edit <code class="filename">/etc/amavis/conf.d/50-user</code> and paste this
    into the file:</p>

    <pre class="screen">use strict;

@local_domains_acl = ( ".$mydomain" );

$sa_spam_subject_tag = 'SPAM &gt; ';
$sa_tag_level_deflt  = -999;  # add spam info headers if at, or above that level
$sa_tag2_level_deflt = 5; # add 'spam detected' headers at that level
$sa_kill_level_deflt = 12; # triggers spam evasive actions

$final_virus_destiny      = D_DISCARD;  # (data not lost, see virus quarantine)
$final_banned_destiny     = D_REJECT;   # D_REJECT when front-end MTA
$final_spam_destiny       = D_DISCARD;
$final_bad_header_destiny = D_PASS;     # False-positive prone (for spam)

#------------ Do not modify anything below this line -------------
1;  # ensure a defined return
</pre>

    <p>Of course, you do not just want to paste stuff into configuration
    files without knowing what are you actually doing. So let us go through
    the file, line by line:</p>

    <pre class="screen">@local_domains_acl = ( ".$mydomain" );</pre>

    <p>This is a list of domains for which this server considers itself as
    a final destination. If you do not add all your domains here, they will
    not be processed by amavis, so if you have more domains on your server,
    except for the default line, this should look something like this:</p>

    <pre class="screen">@local_domains_acl = ( ".$mydomain", "domain2.com", "domain3.org" );</pre>

    <p>Later, we will see how can automate this to read the information
    from the database.</p>

    <pre class="screen">$sa_spam_subject_tag = 'SPAM &gt; ';
$sa_tag_level_deflt  = -999;  # add spam info headers if at, or above that level
$sa_tag2_level_deflt = 5; # add 'spam detected' headers at that level
$sa_kill_level_deflt = 12; # triggers spam evasive actions</pre>

    <p>When SpamAssassin processes message, it gives them a score
    identifying what is the probability of message being a spam.
    <code class="computeroutput">$sa_tag_level_deflt</code> tells amavis that ig
    the score is greater or equal to this level that amavis should append
    X-Spam headers to the message. The score of -999 means that we want to
    apply <code class="computeroutput">X-Spam</code> header to all of our
    messages, so it is easier for us to see why is, or why is not, a message
    considered spam by examining the headers of the message.</p>

    <p><code class="computeroutput">$sa_tag2_level_deflt = 5;</code> is the
    spam level the message needs to reach for amavis to apply the header
    <code class="computeroutput">X-Spam-Flag: YES</code> so we (our mail client)
    knows that this message is considered to be spam. At this level the
    message subject is prefixed with the value of the variable
    <code class="computeroutput">$sa_spam_subject_tag</code>. In this case the
    subject is prefixed with “<code class="computeroutput">SPAM &gt;
    </code>”.</p>

    <p><code class="computeroutput">$sa_kill_level_deflt</code> holds the
    value of the spam level that message needs to reach to do something with
    the message. What we are going to do with messages that are spam depends
    of the value of <code class="computeroutput">$final_spam_destiny
    variable</code>. In this case we are discarding this
    messages.</p>

    <p>This means that the message is not going to reach to recipients
    mailbox at all. But that does not mean that the message is lost. Spam
    messages that are discarded can still be fetched from the system. Default
    configuration is to store them in the
    <code class="filename">/var/lib/amavis/virusmails</code> folder. It is possible to
    store them in the database.</p>

    <p>For releasing quarantined mail you need to add these lines:</p>

    <pre class="screen">$inet_socket_port = [10024,9998];
$interface_policy{'9998'} = 'AM.PDP-INET';
$policy_bank{'AM.PDP-INET'} = {
  protocol =&gt; 'AM.PDP',  # select Amavis policy delegation protocol
  inet_acl =&gt; [qw( 127.0.0.1 [::1] )],  # restrict access to these IP addresses
# auth_required_release =&gt; 0,  # don't require secret_id for amavisd-release
};</pre>

    <p>If you want to store everything in the database you have to add
    these lines as well:</p>

    <pre class="screen">@lookup_sql_dsn =  ( ['DBI:mysql:database=DATABASE-NAME;host=127.0.0.1;port=3306', 'USERNAME', 'PASSWORD']);
@storage_sql_dsn = @lookup_sql_dsn;

$virus_quarantine_method = 'sql:';
$spam_quarantine_method = 'sql:';
$banned_files_quarantine_method = 'sql:';
$bad_header_quarantine_method = 'sql:';</pre>

    <p>For this to work, you will have to create the database in MySQL and
    change the value of <code class="computeroutput">@lookup_sql_dsn</code>
    variable to match your database, username &amp; password. You will have to
    create the tables for this database by looking at the amavis
    documentation). When you set this all up, you can use
    <span class="application">Mailzu</span> or <span class="application">Postvis
    Admin</span> to retrieve the quarantined messages. For users of
    <span class="application">SquirrelMail</span> webmail system, there as a plugin
    called <span class="application">AmavisNewSQL</span> which enables access for
    users to quarantined messages that were addressed to them.</p>

    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      <p>Quarantined messages (on the file system, or in the database) have
      to be deleted periodically!</p>
    </div>

    <p>If you do not want to quarantine any of the messages, change</p>

    <pre class="screen">$virus_quarantine_method = 'sql:';
$spam_quarantine_method = 'sql:';
$banned_files_quarantine_method = 'sql:';
$bad_header_quarantine_method = 'sql:';</pre>

    <p>to</p>

    <pre class="screen">$virus_quarantine_method = undef;
$spam_quarantine_method = undef;
$banned_files_quarantine_method = undef;
$bad_header_quarantine_method = undef;</pre>

    <p>SQL support for amavis, except for easier access to quarantined
    messages also provides features to change spam setting on a per user
    basis. Once you create the database, and configure
    <code class="computeroutput">@lookup_sql_dsn</code> this part is very easy
    achieved by reading through the amavis documentation.</p>

    <p>Messages that have a spam value between
    <code class="computeroutput">$sa_tag2_level_deflt</code> and
    <code class="computeroutput">$sa_kill_level_deflt</code> are delivered into
    the recipients mailbox and marked with “<code class="computeroutput">SPAM
    &gt;</code>” in the subject and have the
    <code class="computeroutput">X-Spam-Flag: YES</code> header added to them.
    Although this may be enough for you, since I use only IMAP access to the
    mailboxes I wanted to move this messages to the <code class="filename">Junk</code>
    folder inside the users mailbox automatically. This has some benefits:
    Inbox will not be filled with spam messages, but in case of a false
    positive, user could check his Junk folder to check for messages marked as
    spam. This folder can also be used for learning SpamAssassing what is
    spam, and if users move the messages that are not recognized as spam to
    this folder instead of deleting them SpamAssassin will get smarter about
    what is considered to be spam, and what is not.</p>

    <p>It's time to restart Postfix and Amavis and commit changes using
    etckeeper.</p>

    <pre class="programlisting">/etc/init.d/postfix restart
/etc/init.d/amavis restart
etckeeper commit "Configured amavisd-new"</pre>
  </div>

  <div class="section" title="4.3.4. DKIM"><div class="titlepage"><div><div><h3 class="title"><a id="antispam.dkim"></a>4.3.4. DKIM</h3></div></div></div>
    

    <p>Using <a class="link" href="http://www.dkim.org/" target="_top">DKIM</a> signing of
    your outgoing emails gives you a better chance (though it depend on the
    recipients server configuration) that your mail does not get classified as
    spam. Bumping down the spam score of valid DKIM signed email can also
    prevent false positives.</p>

    <div class="section" title="4.3.4.1. DKIM check for incoming emails"><div class="titlepage"><div><div><h4 class="title"><a id="antispam.dkim.checking"></a>4.3.4.1. DKIM check for incoming emails</h4></div></div></div>
      

      <p>To enable checking of DKIM in SpamAssasin edit
      <code class="filename">/etc/spamassassin/v312.pre</code> and uncomment this
      line:</p>

      <pre class="screen">loadplugin Mail::SpamAssassin::Plugin::DKIM</pre>

      <p>Make sure to install <span class="application">libmail-dkim-perl</span>
      package.</p>

      <pre class="programlisting">apt-get install libmail-dkim-perl</pre>

      <p>Default score for DKIM signed domains are quite low, I usually set
      in my <code class="filename">/etc/spamassassin/local.cf</code></p>

      <pre class="screen">score DKIM_VERIFIED -1
score DKIM_SIGNED    0</pre>

      <p>so verified DKIM signed emails have a lower spam score. Although,
      be aware, spammers sometime also sign emails with DKIM. But you will at
      least be able to know for sure that the spam email came from the
      specified domain.</p>

      <p>Amavisd-new has a lot of advanced options that you can fine tune
      for DKIM signed emails, but you will have to look at the amavisd-new
      documentation for more information.</p>
    </div>

    <div class="section" title="4.3.4.2. Signing your outgoing mail"><div class="titlepage"><div><div><h4 class="title"><a id="antispam.dkim.signing"></a>4.3.4.2. Signing your outgoing mail</h4></div></div></div>
      

      <p>We are going to sign are outgoing mail using amavisd-new DKIM
      signing (we are not going to use dkim-milters). For this to work as
      expected we will need to distinguish between mail coming from the
      incoming and outgoing emails going through our system because we only
      want to sign outgoing emails.</p>

      <p>We are going to achieve this by classifying users in postfix and
      sending our locally originating emails to amavisd-new on port 10026, and
      all other mail (incoming mail from other domains) we are going to send
      to amavisd-new on the port 10024 as we were doing before DKIM
      implementation.</p>

      <div class="section" title="4.3.4.2.1. Postfix"><div class="titlepage"><div><div><h5 class="title"><a id="antispam.dkim.signing.postfix"></a>4.3.4.2.1. Postfix</h5></div></div></div>
        

        <p>Open up <code class="filename">/etc/postfix/main.cf</code>, find the line
        containing your smtpd_sender_restrictions and add check_sender_acces
        before and after other rules listed there:</p>

        <pre class="screen">smtpd_sender_restrictions =
# If mail is coming from mynetwork or from authenticated users use amavis filtering on port 10026 (DKIM signing)
  check_sender_access regexp:/etc/postfix/amavis/tag_as_originating.re
  permit_mynetworks
  permit_sasl_authenticated
  permit_tls_clientcerts
# For other mail use amavis filtering on port 10024 (skips DKIM signing)
  check_sender_access regexp:/etc/postfix/amavis/tag_as_foreign.re</pre>

        <p>Create
        <code class="filename">/etc/postfix/amavis/tag_as_originating.re</code> and
        insert:</p>

        <pre class="screen">/^/ FILTER smtp-amavis:[127.0.0.1]:10026</pre>

        <p>Create
        <code class="filename">/etc/postfix/amavis/tag_as_foreign.re</code> and
        insert:</p>

        <pre class="screen">/^/ FILTER smtp-amavis:[127.0.0.1]:10024</pre>
      </div>

      <div class="section" title="4.3.4.2.2. Amavisd-new"><div class="titlepage"><div><div><h5 class="title"><a id="antispam.dkim.signing.amavis"></a>4.3.4.2.2. Amavisd-new</h5></div></div></div>
        

        <p>We are going to use one key to sign all of our domain with the
        same key. When you move one of the virtual domains to another server
        you will either have to copy the same private key used for signing
        domains to the other server, or you will have to change the DNS record
        of the domain you are moving so that its TXT record showing the public
        key is updated with the new key that will be used on the other server
        (or disable DKIM signing).</p>

        <p>We are going to generate a new private key and store it in the
        <code class="filename">/etc/amavis/dkim</code>.</p>

        <pre class="programlisting">amavisd-new genrsa /etc/amavis/dkim/atlantis-example-com.key.pem</pre>

        <p>Open <code class="filename">/etc/amavisd.conf/50-user</code> and
        replace</p>

        <pre class="screen">$inet_socket_port = [10024,9998];</pre>

        <p>with</p>

        <pre class="screen">$inet_socket_port = [10024,10026,9998];</pre>

        <p>You also need to enable the dkim signing, so add</p>

        <pre class="screen">$enable_dkim_signing = 1;  # loads DKIM signing code</pre>

        <p>and add the key for all of the domains you want to sign.</p>

        <pre class="screen"># Set keys
dkim_key('example.com', 'mail', '/etc/amavis/dkim/atlantis-example-com.key.pem');
dkim_key('some-other-virtual.com', 'mail', '/etc/amavis/dkim/atlantis-example-com.key.pem');
dkim_key('another-virtual', 'mail', '/etc/amavis/dkim/atlantis-example-com.key.pem');
....</pre>

        <p>If you want to generate a specific private key for every domain
        you just have to edit the path to the key for the domain you want to
        change. mail in this example is a selector and you can put anything
        you like here. The value you enter here has to be inserted on your DNS
        record.</p>

        <p>One more thing we need to do in the
        <code class="filename">/etc/amavis/conf.d/50-user</code> is to create a policy
        that will be used for mail coming on port 1026 that need to be
        signed:</p>

        <pre class="screen"># switch policy bank to 'ORIGINATING' for mail received on port 10026:
$interface_policy{'10026'} = 'ORIGINATING';
$policy_bank{'ORIGINATING'} = {  # mail originating from our users
  originating =&gt; 1,  # indicates client is ours, allows signing
  # force MTA to convert mail to 7-bit before DKIM signing
  # to avoid later conversions which could destroy signature:
  smtpd_discard_ehlo_keywords =&gt; ['8BITMIME'],
};</pre>

        <p>Since this is the policy that is used for outgoing mail you can
        use it to change some other settings as well, but for this you will
        have to consult the amavisd-new documentation on <a class="link" href="http://amavisd.de.postfix.org/amavisd-new-docs.html#pbanks" target="_top">policy
        banks</a>.</p>
      </div>

      <div class="section" title="4.3.4.2.3. DNS"><div class="titlepage"><div><div><h5 class="title"><a id="antispam.dkim.signing.dns"></a>4.3.4.2.3. DNS</h5></div></div></div>
        

        <p>To get the the TXT record which contains the public part of your
        key you have to run:</p>

        <pre class="programlisting">amavisd-new showkeys</pre>

        <p>and you should get something like this:</p>

        <pre class="screen">mail._domainkey.example.com.   3600 TXT (
  "v=DKIM1; p="
  "MIGfMA0GCSqGSIbHASU3KSMA84GNADCBiQKBgQDZNEarYcwLtVJ5y/gMUM8UimUX"
  "Dp9oluwww1KdTGTQkg3OYyYfDyt8ZoutsxT6cnpMvG8D0jLLKy8rHGWE5I7pdQbL"
  "qADufNR/08c7Ti3GSK3/WoWXQv/NzYLXaf7bdSk5f6+XZHCp/EKOuW6I/2Q7dv/B"
  "+rAJJQZggHbolduwCwID2HBR")</pre>

        <p>u have to paste this into your DNS server configuration. If you
        are using an online tool to manage your domain name records (like
        GoDaddys Total DNS Control) you will have to create a new TXT record
        and for the TXT name enter</p>

        <pre class="programlisting">mail._domainkey</pre>

        <p>and for the value you will have to “glue” the multiple lines
        into one and erase all the quotation marks.</p>

        <pre class="screen">v=DKIM1; p=MIGfMA0GCSqGSIbHASU3KSMA84GNAD.....B+rAJJQZggHbolduwCwID2HBR</pre>

        <p>If you used another selector instead of mail you have to enter
        <code class="computeroutput">your-selector._domainkey</code>.</p>
      </div>

      <div class="section" title="4.3.4.2.4. Wrap it up"><div class="titlepage"><div><div><h5 class="title"><a id="id36889338"></a>4.3.4.2.4. Wrap it up</h5></div></div></div>
        

        <p>All that is left to do is to restart amavisd-new and reload
        postfix configuration.</p>

        <pre class="programlisting">/etc/init.d/amavis restart
/etc/init.d/postfix restart</pre>

        <p>If your DNS zone files have refreshed you will be able to
        use</p>

        <pre class="programlisting">amavisd-new testkeys</pre>

        <p>If everything is set up properly this test should pass.</p>

        <pre class="screen">TESTING: mail._domainkey.example.com      =&gt; pass</pre>

        <p>Commit your changes with etckeeper.</p>
      </div>
    </div>
  </div>

  <div class="section" title="4.3.5. RBL lists"><div class="titlepage"><div><div><h3 class="title"><a id="id36889377"></a>4.3.5. RBL lists</h3></div></div></div>
    

    <p><a class="link" href="http://en.wikipedia.org/wiki/DNSBL" target="_top">RBL (DNSBL)
    lists</a> are an efficient way of controlling spam. Postfix has built
    in support for RBL lists. We are going to add checking of RBL list <a class="link" href="http://www.spamhaus.org/zen/" target="_top">zen.spamhaus.org</a> by editing
    <code class="filename">/etc/postfix/main.cf</code> and adding
    <code class="computeroutput">reject_rbl_client zen.spamhaus.org</code> to a
    list of smtpd_recipient_restrictions.</p>

    <pre class="screen">smtpd_recipient_restrictions =
    permit_mynetworks
    permit_sasl_authenticated 
    reject_unauth_destination
    reject_unlisted_recipient
    reject_unverified_recipient
    reject_rbl_client zen.spamhaus.org</pre>
  </div>

  <div class="section" title="4.3.6. Greylisting"><div class="titlepage"><div><div><h3 class="title"><a id="antispam.greylisting"></a>4.3.6. Greylisting</h3></div></div></div>
    

    <p>From all the spam fighting measures I have tried, <a class="link" href="http://en.wikipedia.org/wiki/Greylisting" target="_top">greylisting</a>
    block the most of the spam. Of course, it has its downsides, but if you
    can live with waiting for the first mail from a person for a 30 minutes
    more then normal I highly recommend it.</p>

    <p>There are various greylisting implementations that work with Postfix
    but I recommend <span class="application">sqlgrey</span> because it works with a
    database and has a nice looking GUI so you can manage it using your web
    browser.</p>

    <pre class="programlisting">apt-get install sqlgrey</pre>

    <p>Now we need to create a database and a user for sqlgrey so it can
    connect to the database. Enter <span class="application">mysql</span> and
    run:</p>

    <pre class="screen">mysql&gt; create database mail_sqlgrey;
Query OK, 1 row affected (0.00 sec)

mysql&gt; CREATE USER 'sqlgrey'@'localhost' IDENTIFIED BY 'newpasswd';
Query OK, 0 rows affected (0.02 sec)

mysql&gt; GRANT ALL PRIVILEGES ON `mail_sqlgrey` . * TO 'sqlgrey'@'localhost';
Query OK, 0 rows affected (0.02 sec)</pre>

    <p>Choose your own password naturally. Open
    <code class="filename">/etc/sqlgrey/sqlgrey.conf</code> and edit the database
    settings.</p>

    <pre class="screen">db_type = mysql               
db_name = mail_sqlgrey
# Note: the following are not used with SQLite
db_host = localhost
db_port = default
db_user = sqlgrey
db_pass = newpasswd </pre>

    <p>While you are at it examine the other settings in the config file
    and change them if appropriately.</p>

    <p>Restart <span class="application">sqlgrey</span> and check that the tables
    inside the <code class="computeroutput">mail_sqlgrey</code> database are
    created.</p>

    <pre class="programlisting">/etc/init.d/sqlgrey restart</pre>

    <p>To tell Postfix to use sqlgrey edit
    <code class="filename">/etc/postfix/main.cf</code> and add check_policy_service to
    your <code class="computeroutput">smtpd_recipient_resctriction</code>
    directive.</p>

    <pre class="screen">smtpd_recipient_restrictions =
    ... your other rules ...
    check_policy_service inet:127.0.0.1:2501</pre>

    <p>Restart Postfix and commit your changes.</p>

    <pre class="programlisting">/etc/init.d/postfix restart
etckeeper commit "Added greylisting to Postfix"</pre>

    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      <p>If you want to use a web interface to edit the white- and
      blacklists as well as the current state of the greylist take a look at
      <a class="link" href="http://www.vanheusden.com/sgwi/" target="_top">sgwi</a>.</p>
    </div>
  </div>
</div>
  <div class="section" title="4.4. Utilities"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="utilities"></a>4.4. Utilities</h2></div></div></div>
  

  <div class="section" title="4.4.1. Maildrop"><div class="titlepage"><div><div><h3 class="title"><a id="utilities.maildrop"></a>4.4.1. Maildrop</h3></div></div></div>
    

    <p>Postfix has a built in local delivery agent, but to provide quota
    support and moving messages marked as spam into separate folders we are
    going to replace it with <span class="application">Maildrop</span>.</p>

    <p>To install maildrop, run</p>

    <pre class="programlisting">apt-get install maildrop</pre>

    <p>Maildrop config file is located at
    <code class="filename">/etc/maildroprc</code>, open it and replace the content with
    this:</p>

    <pre class="screen"># Global maildrop filter file (used on Debian)
# For use with Postfix/Courier IMAP/Amavisd-new virtual mailbox domains.
#
# This maildroprc automagically creates a Spam folder for the recipient
# and places spam there. It also subscibes the recipient to the folder.
#
# Example maildir: /home/vmail/example.com/user/
#
# Also in main.cf:
# virtual_transport = maildrop
# maildrop_destination_concurrency_limit = 2
# maildrop_destination_recipient_limit = 1
#
# and in master.cf:
#
# maildrop  unix  -       n       n       -       -       pipe
#  flags=DRhu user=vmail:vmail argv=/usr/bin/maildrop -w 90 -d ${user}@${nexthop}
#  ${extension} ${recipient} ${user} ${nexthop}
#
# /var/log/maildroprc.log needs to exist and owned by vmail:vmail and
# a logrotate script needs to be created.
#
HOME_DIR="/home/vmail"
logfile "/var/log/maildroprc.log"
EXTENSION="$1"
RECIPIENT=tolower("$2")
USER="$3"
HOST="$4"
SENDER="$5"
DEFAULT="$HOME_DIR/$HOST/$USER"
 
# Check if host and user directory exist
 
`test -e $HOME_DIR/$HOST/$USER`
#log "Testing for $HOME_DIR/$HOST subdirectory: result=$RETURNCODE"
# Only continue if directory does NOT exist
if ($RETURNCODE != 0)
{
        log "MailDir $HOME_DIR/$HOST/$USER does NOT exist"
        `test -e $HOME_DIR/$HOST`
        if ( $RETURNCODE != 0 )
        {
                log "Creating $HOME_DIR/$HOST"
                `mkdir $HOME_DIR/$HOST`
                `chmod -R 0700 $HOME_DIR/$HOST`
        }
 
        # Create users MailDir
        `maildirmake $HOME_DIR/$HOST/$USER`
}
 
if (/^X-Spam-Flag: YES/)
{
        EXTENSION = "Junk"
 
        # See if the spam directory already exists
        `test -e $HOME_DIR/$HOST/$USER/.$EXTENSION`
        #log "Testing for $EXTENSION subdirectory: result=$RETURNCODE"
        if ( $RETURNCODE != 0 ) # spam directory does not exist - so we create it
        {
                # Create the subdirectory
                `maildirmake -f $EXTENSION $HOME_DIR/$HOST/$USER`
                log "Ran \"maildirmake -f $EXTENSION $HOME_DIR/$HOST/$USER\""
 
                # Auto-subscribe the subdirectory
                `if ! grep -q INBOX.$EXTENSION $HOME_DIR/$HOST/$USER/courierimapsubscribed; then echo INBOX.$EXTENSION &gt;&gt; $HOME_DIR/$HOST/$USER/courierimapsubscribed; fi`
        }
 
        # Deliver the message to the mailbox
        exception {
                # for those who unsubscribed themselves - subscribe them
                `if ! grep -q INBOX.$EXTENSION $HOME_DIR/$HOST/$USER/courierimapsubscribed; then echo INBOX.$EXTENSION &gt;&gt; $HOME_DIR/$HOST/$USER/courierimapsubscribed; fi`
                to "$HOME_DIR/$HOST/$USER/.$EXTENSION"
        }
}</pre>

    <p>This script does two things:</p>

    <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
        <p>Creates the folders for the users mail on the server if they do
        not exist (this is the part that Postfix virtual delivery agent does
        automatically).</p>
      </li><li class="listitem">
        <p>Checks if the messages has the <code class="computeroutput">X-Spam-Flag:
        YES</code> header and delivers the message to the Junk
        folder (it creates one if it doesn't exist).</p>
      </li></ul></div>

    <p>We also need to create a log file and change its permission.</p>

    <pre class="programlisting">touch /var/log/maildroprc.log
chown vmail:vmail /var/log/maildroprc.log</pre>

    <p>To automatically rotate logs for the maildroprc.log file create
    <code class="filename">/etc/logrotate.d/maildroprc</code> with the following
    content:</p>

    <pre class="screen">/var/log/maildroprc.log {
    rotate 7
    daily
    compress
    delaycompress
    copytruncate
    notifempty
}</pre>

    <p>To tell Postfix to use Maildrop as a local delivery agent edit
    <code class="filename">/etc/postfix/main.cf</code> and add</p>

    <pre class="screen">virtual_transport = maildrop
maildrop_destination_concurrency_limit = 2
maildrop_destination_recipient_limit = 1</pre>

    <div class="important" title="Important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3>
      <p>You already have <code class="computeroutput">virtual_transport =
      virtual</code>, you have to replace this line and change
      <code class="computeroutput">virtual</code> to
      <code class="computeroutput">maildrop</code>.</p>
    </div>

    <p>Edit <code class="filename">/etc/postfix/master.cf</code> and replace</p>

    <pre class="screen">maildrop  unix  -       n       n       -       -       pipe
  flags=DRhu user=vmail argv=/usr/bin/maildrop -d ${recipient}</pre>

    <p>with</p>

    <pre class="screen">maildrop  unix  -       n       n       -       -       pipe
  flags=ODRhu user=vmail:vmail argv=/usr/bin/maildrop -w 90 -d ${user}@${nexthop}
  ${extension} ${recipient} ${user} ${nexthop}</pre>

    <p>As you can see we are invoking maildrop as user:group “vmail:vmail”.
    Maildrop on Debian is compiled against the courier-authlib library which
    need access to the <code class="filename">/var/run/courier/authdaemon
    folder</code>. Debian package sets user/group permission to
    daemon:daemon on this folder. To force maildrop to work when invoked as
    vmail:vmail we need to change the group ownership of this folder to
    <code class="systemitem">vmail</code>.</p>

    <pre class="programlisting">chgrp vmail /var/run/courier/authdaemon</pre>

    <p>As you can see we are invoking maildrop with two parameters.
    <code class="computeroutput">-w 90</code> tells maildrop to copy the quota
    warning message if the user is over 90% of his mailbox quota.</p>

    <p>The quota warning message must be located in
    <code class="filename">/etc/quotawarnmsg</code> and it should look something like
    this:</p>

    <pre class="screen">X-Comment: Rename/Copy this file to quotawarnmsg, and make appropriate changes
X-Comment: See deliverquota man page for more information
From: Mail Delivery System &lt;postmaster@example.com&gt;
Reply-To: postmaster@example.com
To: Valued Customer:;
Subject: Mail quota warning
Mime-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
Content-Transfer-Encoding: 7bit

Your mailbox on the server is now more than 90% full. So that you can continue to receive mail you need to remove some messages from your mailbox</pre>

    <p>Unfortunately Postfix Admin does not allow entering quota values,
    but id does create the needed columns in the database table mbox. To enter
    quota values log into mysql and add the quota value for the mailbox you
    wish to have quota applied. Your mailbox should have something like
    this:</p>

    <pre class="screen">mysql&gt; select * from mailbox;
+-----------------+----------+-------------+--------------------+-----------+------------+--------------+---------------------+---------------------+--------+
| username        | password | name        | maildir            | quota     | local_part | domain       | created             | modified            | active |
+-----------------+----------+-------------+--------------------+-----------+------------+--------------+---------------------+---------------------+--------+
| gog@example.com | ommited  | Goran Juric | mail@example.com/  | 100000000 | mail       | example.com  | 2009-04-14 00:53:38 | 2009-04-14 00:53:38 |      1 |
</pre>

    <p>Maildrop will get quota information using Couriers
    <code class="filename">/etc/courier/authmysqlrc</code> settings we set earlier.
    That is the reason why we have added <code class="computeroutput">MYSQL_QUOTA_FIELD
    concat(quota,'S')</code> in
    <code class="filename">authmysqlrc</code>.</p>

    <p>Change the permissions on
    <code class="filename">/var/lib/amavis/tmp</code></p>

    <pre class="programlisting">chmod -R 775 /var/lib/amavis/tmp</pre>

    <p>We also need to restart Amavisd-new and Postfix.</p>

    <pre class="programlisting">/etc/init.d/amavis restart
/etc/init.d/postfix restart</pre>

    <p>Send a test email to check that everything is working and commit
    your changes with <span class="application">etckeeper</span>.</p>

    <div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3>
      <p>Examine /var/log/maildroprc.log and /var/log/mail.info if you are
      expiriencing problems.</p>
    </div>

    <div class="section" title="4.4.1.1. Per user filtering"><div class="titlepage"><div><div><h4 class="title"><a id="id36889777"></a>4.4.1.1. Per user filtering</h4></div></div></div>
      

      <p>If you would like to have the ability to provide per user
      filtering you will have to modify <code class="filename">/etc/maildroprc</code>
      to check if there is a “<code class="filename">mailfilter</code>” file in the
      users directory and if it's found that it gets included.</p>

      <p>You can change it like this</p>

      <pre class="screen">[....]
        # Create users MailDir
        `maildirmake $HOME_DIR/$HOST/$USER`
}
 
`test -e $DEFAULT/mailfilter`
if ( $RETURNCODE == 0 )
{
     exception {
         log "Including $HOME_DIR/$HOST/$USER/mailfilter..."
         include "$HOME_DIR/$HOST/$USER/mailfilter"
     }
}
 
if (/^X-Spam-Flag: YES/)
[...]</pre>

      <p>All you have to do now is to put your rules in the mailfilter
      file.</p>
    </div>
  </div>

  <div class="section" title="4.4.2. Vacation"><div class="titlepage"><div><div><h3 class="title"><a id="id36889545"></a>4.4.2. Vacation</h3></div></div></div>
    

    <p>Vacation plugin</p>
  </div>

  <div class="section" title="4.4.3. Mailing lists"><div class="titlepage"><div><div><h3 class="title"><a id="id36889820"></a>4.4.3. Mailing lists</h3></div></div></div>
    

    <p>Mailman integration.</p>
  </div>
</div>

</div>

  <div class="chapter" title="Chapter 5. TODO"><div class="titlepage"><div><div><h2 class="title"><a id="todo"></a>Chapter 5. TODO</h2></div></div></div>
  
  

      <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
          <p>
              Fetching mail with mailman
          </p>
        </li><li class="listitem">
          <p>
              Mailing lists - Mailman
          </p>
        </li><li class="listitem">
          <p>
              Setting up satellite boxes
          </p>
        </li><li class="listitem">
          <p>
              DNS caching
          </p>
        </li><li class="listitem">
          <p>
              Disabling IPv6
          </p>
        </li></ul></div>
</div>
</div></body></html>
