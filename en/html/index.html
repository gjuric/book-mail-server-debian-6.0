<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Building a mail server on Debian 6.0 (Squeeze)</title><link rel="stylesheet" href="docbook.css" type="text/css" /><meta name="generator" content="DocBook XSL Stylesheets V1.75.0" /><link rel="home" href="#id36882107" title="Building a mail server on Debian 6.0 (Squeeze)" /><link rel="next" href="#id36882054" title="Foreword" /></head><body><div class="book" title="Building a mail server on Debian 6.0 (Squeeze)"><div class="titlepage"><div><div><h1 class="title"><a id="id36882107"></a>Building a mail server on Debian 6.0 (Squeeze)</h1></div><div><div class="author"><h3 class="author"><span class="firstname">Goran</span> <span class="surname">Jurić</span></h3></div></div><div><p class="releaseinfo">
      This is version 0.0.1 of Building a mail server on Debian.
    </p></div><div><p class="copyright">Copyright © 2010 Goran Jurić</p></div><div><div class="legalnotice" title="Legal Notices"><a id="id36882086"></a>
      <p class="legalnotice-title"><b>Legal Notices</b></p>

      <p>Permission is granted to copy, distribute and/or modify this
      document under the terms of the GNU Free Documentation
      License (GFDL), Version 1.1 or any later version published
      by the Free Software Foundation with no Invariant Sections,
      no Front-Cover Texts, and no Back-Cover Texts.  You can find
      a copy of the GFDL at this
      <a class="link" href="http://www.gnu.org/copyleft/fdl.html" target="_top">link</a>.
      </p>
    </div></div></div><hr /></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="preface"><a href="#id36882054">Foreword</a></span></dt><dt><span class="chapter"><a href="#introduction">1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#introduction.why.postfix">1.1. Why Postfix</a></span></dt><dt><span class="section"><a href="#introduction.why.debian">1.2. Why Debian</a></span></dt><dt><span class="section"><a href="#introduction.software-used">1.3. Sofware used</a></span></dt><dt><span class="section"><a href="#introduction.required-knowledge">1.4. Required knowledge</a></span></dt></dl></dd><dt><span class="chapter"><a href="#preparation">2. Preparation</a></span></dt><dd><dl><dt><span class="section"><a href="#preparation.debian-installation">2.1. Debian installation</a></span></dt><dt><span class="section"><a href="#preparation.tracking-changes">2.2. Tracking configuration changes</a></span></dt><dt><span class="section"><a href="#preparation.essentials">2.3. Essential software</a></span></dt><dt><span class="section"><a href="#preparation.static-ip">2.4. Setting a static IP address</a></span></dt><dt><span class="section"><a href="#preparation.ntp">2.5. NTP - time synchronization</a></span></dt></dl></dd><dt><span class="chapter"><a href="#mail-server">3. Mail server</a></span></dt><dd><dl><dt><span class="section"><a href="#mail-server.dns">3.1. DNS settings</a></span></dt><dt><span class="section"><a href="#postfix">3.2. Postfix</a></span></dt><dd><dl><dt><span class="section"><a href="#postfix.inital-settings">3.2.1. Initial settings</a></span></dt><dt><span class="section"><a href="#postfix.virtual-users">3.2.2. Virtual users and domains</a></span></dt><dt><span class="section"><a href="#postfix.mysql">3.2.3. MySQL</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#todo">4. TODO</a></span></dt></dl></div>
  

  <div class="preface" title="Foreword"><div class="titlepage"><div><div><h2 class="title"><a id="id36882054"></a>Foreword</h2></div></div></div>
    

    <p>The internet is full of information on how to do just about
    anything. But this vast amount of information makes it hard to find and
    glue all of the pieces to fit together.</p>

    <p>The goal of this manual is to provide you with enough knowledge to
    feel confident in installing and maintaing your own mail server. Of course
    manuals like this already exist but during my search for knowledge I
    always felt like they were either not updated in a while or they just skip
    over some of the most interesting parts assuming you know what they are
    talking about.</p>

    <p>I will do my best to explain why and not just how.</p>

    <p>This manual does not even come close to explaining the intricacies
    of a Postfix mail server. If you want to know more you really should read
    "The Book of Postfix: State-of-the-Art Message Transport" by Ralf
    Hildebrandt and Patrick Koetter.</p>
  </div>

  <div class="chapter" title="Chapter 1. Introduction"><div class="titlepage"><div><div><h2 class="title"><a id="introduction"></a>Chapter 1. Introduction</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#introduction.why.postfix">1.1. Why Postfix</a></span></dt><dt><span class="section"><a href="#introduction.why.debian">1.2. Why Debian</a></span></dt><dt><span class="section"><a href="#introduction.software-used">1.3. Sofware used</a></span></dt><dt><span class="section"><a href="#introduction.required-knowledge">1.4. Required knowledge</a></span></dt></dl></div>
  

  <div class="section" title="1.1. Why Postfix"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="introduction.why.postfix"></a>1.1. Why Postfix</h2></div></div></div>
    

    <p>Most of you know that there are a number of different distributions
    and mail transfer agents that could be used to build an equally capable
    mail server.</p>

    <p>The only other mail server I had experience working on is build on
    CentOS and it is called <code class="uri"><a class="uri" href="http://www.qmailtoaster.com/" target="_top">Qmail Toaster</a></code>. Qmail Toaster has a lot of
    strengths. It is a ready made software library which you can install and
    the installer will take care of setting up a bunch of different programs
    and utilities that are needed for a mail server.</p>

    <p>On the other hand, from what I have seen, it has it's share of
    quirks and the biggest one for me is that it uses Qmail. Qmail is not a
    bad MTA (Mail Transfer Agent) but it is not being actively developed for
    years and a lot of the functionality is provided through patches.</p>

    <p>Postfix is on the other hand an actively developed project and all
    of the requirements a modern mail server could have are either present in
    Postfix itself or they can be provided through other applications.</p>
  </div>

  <div class="section" title="1.2. Why Debian"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="introduction.why.debian"></a>1.2. Why Debian</h2></div></div></div>
    

    <p>Debian 3.0 (woody) is the first distribution I installed on a server
    and since than I fell in live with it. Debian was at the time the
    distribution with most packages provided in their repositories. Some of
    you maybe like to compile their own software, but for me software provided
    through distributions package management was always easier to maintain and
    upgrade and not to mention stable.</p>

    <p>CentOS is also a nice distribution, but the version of Postfix
    shipped with the current release of Centos (5.6 at the time of writing) is
    ancient and is not really even supported by the author. Not to mention
    that the number of software packages provided through the official
    repositories does not even come close to Debians.</p>

    <p>Software in the stable Debian distribution may be older than the one
    provided in Ubuntu, but I have more trust in Debian. Your milage may
    vary.</p>
  </div>

  <div class="section" title="1.3. Sofware used"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="introduction.software-used"></a>1.3. Sofware used</h2></div></div></div>
    

    <p>Here is a short list of applications we are going to use to build a
    mail server.</p>

    <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
        <p>Postfix - Mail Transfer Agent</p>
      </li><li class="listitem">
        <p>Courier - an IMAP/POP3 server</p>
      </li><li class="listitem">
        <p>SpamAssassin - for filtering spam messages</p>
      </li><li class="listitem">
        <p>ClamAV - antivirus</p>
      </li><li class="listitem">
        <p>Amavisd-new - a glue that glues Postfix with SpamAssassin and
        ClamAV</p>
      </li><li class="listitem">
        <p>Sqlgrey - for greylisting emails</p>
      </li><li class="listitem">
        <p>MySQL - for storing information about users, domains and
        settings</p>
      </li><li class="listitem">
        <p>Maildrop - for delivering mails to users mailboxes</p>
      </li></ul></div>
  </div>

  <div class="section" title="1.4. Required knowledge"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="introduction.required-knowledge"></a>1.4. Required knowledge</h2></div></div></div>
    

    <p>This is not a beginners guide to Unix. You should know your away
    around a unix shell and familiarize yourself with Debians package
    management <span class="emphasis"><em>apt</em></span>.</p>
  </div>
</div>

  <div class="chapter" title="Chapter 2. Preparation"><div class="titlepage"><div><div><h2 class="title"><a id="preparation"></a>Chapter 2. Preparation</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#preparation.debian-installation">2.1. Debian installation</a></span></dt><dt><span class="section"><a href="#preparation.tracking-changes">2.2. Tracking configuration changes</a></span></dt><dt><span class="section"><a href="#preparation.essentials">2.3. Essential software</a></span></dt><dt><span class="section"><a href="#preparation.static-ip">2.4. Setting a static IP address</a></span></dt><dt><span class="section"><a href="#preparation.ntp">2.5. NTP - time synchronization</a></span></dt></dl></div>
  

  <div class="section" title="2.1. Debian installation"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="preparation.debian-installation"></a>2.1. Debian installation</h2></div></div></div>
    

    <p>Download Debian 6.0 (32/64-bit PC Network installer) from <code class="uri"><a class="uri" href="http://www.debian.org/" target="_top">
    www.debian.org</a></code> and burn the image to a compact disc, or mount it as
    a CD image in your virtualisation software.</p>

    <p>Boot your computer and select Install (or Install 64 if you want the
    64-bit version). Choose your Language, Country and Keymap. If your
    computer is not connected to a network with <acronym class="acronym">DHCP</acronym> you
    will be prompted to enter network connection parameter manually. After
    configuring your network and <acronym class="acronym">DNS</acronym> server you will be
    asked for a hostname, in our case, the hostname is <code class="systemitem">atlantis</code> and our domain name is
    <code class="systemitem">example.com </code>.</p>

    <p>When prompted to select Debian mirror the selected choice is usually
    the best one. If you are not using <acronym class="acronym">HTTP</acronym> proxy on your
    internet connection, or don't know what HTTP proxy is, just leave this
    field blank.</p>

    <p>When prompted to partition the disk for a Debian install, choose
    <code class="computeroutput">Guided - use entire disk. Install all files in one
    partition</code>.</p>

    <p>Grab a cup of coffee and wait until installation finishes fetching
    packages from the internet and installs the base system.</p>

    <p>Enter your root password. This is a password for root user who has
    all the privileges on the system, so choose one carefully. After that, you
    have to create a new user for the system.</p>

    <p>You will be asked if you want to participate in the Debians
    popularity contest which collects information about most used packages.
    Feel free to answer whatever you like, by choosing Yes you are helping
    Debian community find the most used packages in the distribution. Help
    them out, it doesn't cost a thing.</p>

    <p>When prompted to select collections of software packages deselect
    everything, including the <code class="computeroutput">Standard system
    utilities</code> We just need to install the base system because
    we will add all needed packages when and if we need them.</p>

    <p>I strongly believe that you should install the minimum required
    number of packages needed for the system to operate. You will not have to
    update and upgrade packages that you do not even use. And knowing which
    package provides certain utilities is a fun exercise in getting to know
    your system a little better.</p>

    <p>Since Debian will be the only system on our machine you must install
    GRUB on to the master boot record when prompted.</p>

    <p>Your Debian system is almost ready to go. When asked, remove the
    installation media from your drive (or unmount the image in your
    virtualisation software) and reboot your computer.</p>

    <p>When your computer boots up you can log in with the root user
    account and update the packages in your system by running:</p>

    <pre class="programlisting">apt-get update
apt-get upgrade</pre>

    <p>And that's it. Your new Debian system is installed and ready for
    configuration.</p>
  </div>

  <div class="section" title="2.2. Tracking configuration changes"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="preparation.tracking-changes"></a>2.2. Tracking configuration changes</h2></div></div></div>
    

    <p>During the course of this manual, we will edit a lot of
    configuration files and install many application packages and sometimes it
    is really hard to remember what we did and why after a couple of months
    have passed.</p>

    <p>To stay on top of the game we will use
    <span class="application">etckeeper</span>.</p>

    <p>Etckeeper is an application that uses version control systems like
    git, Bazaar or Mercurial to track changes made to the <code class="filename">/etc</code> folder.</p>

    <pre class="programlisting">apt-get install etckeeper</pre>

    <p>Etckeeper in Debian uses git for tracking changes and is set to
    automatically commit all of the changes before a new package is installed
    as well as to auto commit changes on a daily bases.</p>

    <p>Since i do now want to forget to describe changes I mage to the
    files in <code class="filename">/etc</code> I usaully disable
    automatic commits. Edit <code class="filename">/etc/ectkeeper/etckeeper.conf</code>
    and uncomment out these two lines:</p>

    <pre class="programlisting">AVOID_DAILY_AUTOCOMMITS=1
AVOID_COMMIT_BEFORE_INSTALL=1</pre>

    <p>Set name and email git will use for the commit log by running this
    two commands at the shell:</p>

    <pre class="programlisting">git config --global user.name "Your Name"
git config --global user.email you@example.com</pre>

    <p>It is time for our first commit</p>

    <pre class="programlisting">etckeeper commit "Changed etckeeper settings to disable auto commits"</pre>

    <p>To view the change log navigate to the <code class="filename">/etc</code> folder and run:</p>

    <pre class="programlisting">git log</pre>

    <p>You can learn more about git and etckeeper at the projects homepage.
    Just remember to commit your changes after the each change you make or you
    will not be able to install packages because etckeeper will complain that
    there are uncommitted changes in the folder.</p>
  </div>

  <div class="section" title="2.3. Essential software"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="preparation.essentials"></a>2.3. Essential software</h2></div></div></div>
    

    <p>First, we are going to install some software that we will use later
    in the manual.</p>

    <pre class="programlisting">apt-get install openssh-server nano dnsutils bsd-mailx telnet </pre>

    <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
        SSH server will allow us to connect remotely to the server.
      </li><li class="listitem">
        Nano is a text editor. More user friendly than vi.
      </li><li class="listitem">
        We will use wget to fetch stuff from the internet.
      </li><li class="listitem">
        dnsutils package will allow us to troubleshoot possible DNS problems on our system.
      </li><li class="listitem">
        Telnet and bsd-mailx will be used later for troubleshooting our setup.
      </li></ul></div>
  </div>

  <div class="section" title="2.4. Setting a static IP address"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="preparation.static-ip"></a>2.4. Setting a static IP address</h2></div></div></div>
    

    <p>If you didn't enter the IP address during the installation of the
    server, you probably got an address from the DHCP server. Since servers IP
    address should not be changed you will have to set a static IP address for
    your sever.</p>

    <p>Enter ifconfig at the prompt and copy the output somewhere so you
    have access to network information you got from a DHCP server.</p>

    <p>Open up <code class="filename">/etc/network/interfaces</code> with nano and
    replace</p>

    <pre class="programlisting">auto eth0
iface eth0 inet dhcp</pre>

    <p>with</p>

    <pre class="programlisting">iface eth0 inet static
    address YOUR-IP
    netmask YOUR-NETMASK
    network YOUR-NETWORK
    broadcast YOUR-BROADCAST
    gateway YOUR-GATEWAY
    # dns-* options are implemented by the resolvconf package, if installed
    dns-nameservers YOUR-DNS-SERVERS-SEPARATED-BY-SPACE
    dns-search YOUR-DOMAIN</pre>

    <div class="caution" title="Caution" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Caution</h3>
      <p>If you are using another interface for the connection replace
      <code class="computeroutput">eth0</code> with the interface you are
      using.</p>
    </div>

    <p>Reboot your server, check that your internet connection is working
    (try to ping google.com or some other host) and if everything is ok you
    can remove packages that provide DHCP from your system.</p>

    <pre class="programlisting">
apt-get --purge remove isc-dhcp-client isc-dhcp-common</pre>

    <p>Note that option –purge removes configuration files of the packages
    we are removing. If you do not use –purge they will be left on your
    system.</p>
  </div>

  <div class="section" title="2.5. NTP - time synchronization"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="preparation.ntp"></a>2.5. NTP - time synchronization</h2></div></div></div>
    

    <p>To make sure our servers time is always up to date we are going to
    install ntp package which enables our server to use NTP protocol for
    syncing your servers clock.</p>

    <pre class="programlisting">apt-get install ntp</pre>

    <p>If your data center or VPS provider offers an NTP service use their
    NTP server. Open up <code class="filename">/etc/ntp.conf</code> with nano and
    replace:</p>

    <pre class="programlisting">server 0.debian.pool.ntp.org iburst dynamic
server 1.debian.pool.ntp.org iburst dynamic
server 2.debian.pool.ntp.org iburst dynamic
server 3.debian.pool.ntp.org iburst dynamic</pre>

    <p>with</p>

    <pre class="programlisting">server ADDRESS-OF-NTP-SERVER-YOU-WANT-TO-USE</pre>

    <p>You should have at least two servers in the ntp.conf.</p>

    <p>After saving the changes you have to restart the NTP service by
    running</p>

    <pre class="programlisting">invoke-rc.d ntp restart</pre>

    <p>Note: invoke-rc.d is Debians shortcut to /etc/init.d/. You can run
    <code class="computeroutput">/etc/init.d/ntp restart</code> as well.</p>

    <p>You can examine if the NTP server is working as expected if you run
    the ntpq -p command:</p>

    <pre class="screen">example:~# ntpq -p

    remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
zg1.ntp.CARNet. 161.53.1.2       2 u   58   64    3    7.157  106.619   4.158
zg2.ntp.CARNet. 161.53.1.2       2 u   57   64    3    7.677   25.934   4.792
morcic.RI.CARNe 161.53.1.2       2 u   58   64    3   11.796   26.527   7.751</pre>

    <p>After a while the reach column should have values greather that 0.
    Which means that the NTP servers we are pooling for time information are
    reachable.</p>

    <div class="caution" title="Caution" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Caution</h3>
      <p>If your clock was way of from the current time NTP will not sync
      your servers time. In that case stop the NTP daemon. Set the time and
      date manually (or you can install and use the ntpdate utility) and run
      the NTP daemon again.</p>
    </div>
  </div>
</div>

  <div class="chapter" title="Chapter 3. Mail server"><div class="titlepage"><div><div><h2 class="title"><a id="mail-server"></a>Chapter 3. Mail server</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#mail-server.dns">3.1. DNS settings</a></span></dt><dt><span class="section"><a href="#postfix">3.2. Postfix</a></span></dt><dd><dl><dt><span class="section"><a href="#postfix.inital-settings">3.2.1. Initial settings</a></span></dt><dt><span class="section"><a href="#postfix.virtual-users">3.2.2. Virtual users and domains</a></span></dt><dt><span class="section"><a href="#postfix.mysql">3.2.3. MySQL</a></span></dt></dl></dd></dl></div>
  

  <p>We are going to install <span class="application">Postfix</span> as our MTA
  (SMTP server) and <span class="application">Courier</span> as our POP/IMAP server.
  <span class="application">Postfix</span> will use virtual domains, and information
  about our domains and users will be stored in the
  <span class="application">MySQL</span> database.</p>

  <p>For managing virtual domains and users we will use
  <span class="application">PostfixAdmin</span>. For virus scanning and spam
  protection of our emails we will use <span class="application">ClamAV</span> and
  <span class="application">Spamassassin</span> that will be run using
  <span class="application">amavisd-new</span>.</p>

  <p>As a local delivery agent we will use
  <span class="application">Maildrop</span> that will be configured to move all
  messages marked as spam to the Junk folder as well as to make sure that
  users do not go over their assigned quota.</p>

  <p>This implementation of quota on the mail system does not require you
  to patch Postfix.</p>

  <p>All software is installed from official Debian repositories.</p>

  <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
    <p>This tutorial is a combination of tutorials published on <a class="link" href="http://articles.slicehost.com/email" target="_top">http://articles.slicehost.com/email</a>
    and <a class="link" href="https://help.ubuntu.com/community/PostfixCompleteVirtualMailSystemHowto" target="_top">https://help.ubuntu.com/community/PostfixCompleteVirtualMailSystemHowto</a>
    and a lot of my own work. You also must have a valid MX record in the DNS
    zone of your domain pointing to the IP address of the server.</p>
  </div>

  <div class="section" title="3.1. DNS settings"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="mail-server.dns"></a>3.1. DNS settings</h2></div></div></div>
    

    <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      <p>Mail server in this example is named <code class="systemitem">atlantis.example.com</code>. You can also
      name it <code class="systemitem">mail.example.com</code>
      if you like.</p>
    </div>

    <p>First, we need to check our hostname</p>

    <pre class="screen">atlantis:~# <span class="command"><strong>hostname -f</strong></span>
atlantis.diabmon.com </pre>

    <p>If hostname did not return FQDN of your server edit
    <code class="filename">/etc/hosts</code>. You <code class="filename">hosts</code> file
    should look something like this, if not, change according to your IP
    address and server name.</p>

    <pre class="programlisting">127.0.0.1       localhost
YOUR-IP-ADDRESS atlantis.example.com atlantis </pre>

    <p>Now check your <code class="filename">/etc/hostname</code> file it should
    contain your fully qualified domain name:</p>

    <pre class="programlisting">atlantis.example.com </pre>

    <p>Change the names to match your server name and reboot the server.
    Run <span class="command"><strong>hostname -f</strong></span> again and you should see <code class="systemitem">atlantis.example.com</code>.</p>

    <p>Now, we need to check that our DNS servers have an MX record for our
    <code class="systemitem">example.com</code> domain. If you
    haven't done so already Install DNS utilities:</p>

    <pre class="programlisting">apt-get install dnsutils</pre>

    <p>We are going to use <span class="command"><strong>host</strong></span> command to check
    information about our domain:</p>

    <pre class="screen">atlantis:~# <span class="command"><strong>host</strong></span> example.com
example.com has address YOUR-IP-ADDRESS
example.com mail is handled by 0 mail.example.com. </pre>

    <p>We can see that the mail for our domain is handled by <code class="systemitem">mail.example.com</code>. Which server is
    supposed to handle mail for your domain is handled by the so called MX
    records in your domains zone file. Setting up DNS zone files is out of
    scope for this document.</p>

    <p>Now we must make sure that <code class="systemitem">mail.example.com</code> points to the same
    address as our server (<code class="systemitem">atlantis.example.com</code>).</p>

    <pre class="screen">atlantis:~# <span class="command"><strong>nslookup</strong></span> mail.example.com
Server: YOUR-DNS-SERVER
Address: YOUR-DNS-ADDRESS#53

Non-authoritative answer:
mail.example.com canonical name = atlantis.example.com.
Name: example.com
Address: YOUR-IP-ADDRESS </pre>

    <p>It would be also nice if your reverse DNS points to the same name
    (<code class="systemitem">atlantis.example.com</code>).</p>

    <pre class="screen">atlantis:~# <span class="command"><strong>nslookup</strong></span> YOUR-IP-ADDRESS
Server: YOUR-DNS-SERVER
Address: YOUR-DNS-SERVER#53

Non-authoritative answer: 
YOUR-IP-ADDRES-REVERSE.in-addr.arpa name = atlantis.example.com. </pre>

    <p>If they do not match you will probably have to ask your ISP to
    change this for you.</p>
  </div>

  <div class="section" title="3.2. Postfix"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="postfix"></a>3.2. Postfix</h2></div></div></div>
    

    <p>The time has finally come to install
    <span class="application">Postfix</span>.</p>

    <pre class="programlisting">apt-get install postfix</pre>

    <p>During installation Postfix will ask you to choose the type of
    installation and a domain.</p>

    <p>Choose <code class="computeroutput">Internet site</code> and enter your
    servers name <code class="computeroutput"><code class="systemitem">atlantis.example.com</code></code>.
    It is important that your server name is not just <code class="systemitem">example.com</code>.</p>

    <p>After installation finishes we can check if Postfix is runing by
    connecting to port 25 on your localhost with telnet:</p>

    <pre class="screen"># <span class="command"><strong>telnet</strong></span> localhost 25
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
220 atlantis.example.com ESMTP Postfix (Debian/GNU)</pre>

    <p>Type <span class="command"><strong>quit</strong></span> to exit.</p>

    <p>If you see Postfix responding, Postfix is working. For another check
    we can try to send email to one of your email accounts that are located on
    another server:</p>

    <a id="postfix.test-email-sending"></a><pre class="screen">atlantis:~# <span class="command"><strong>mail</strong></span> your-other-email@somedomain.com
Subject: test email from example.com
test body of the email.
.
Cc:</pre>

    <p>The single dot on the line is a sign that your are done with the
    emails body.</p>

    <p>You should be getting this email message on the account you
    specified.</p>

    <p>Check that you have your <code class="systemitem">example.com</code> in a file
    <code class="filename">/etc/mailname</code>.</p>

    <div class="section" title="3.2.1. Initial settings"><div class="titlepage"><div><div><h3 class="title"><a id="postfix.inital-settings"></a>3.2.1. Initial settings</h3></div></div></div>
      

      <div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
        <p>Do not be afraid to play with config files at this stage. If you
        installed <span class="application">etckeeper</span> <a class="link" href="#preparation.tracking-changes" title="2.2. Tracking configuration changes">as suggested</a>, you can
        always revert to the previous state. Just remember to commit your
        changes every time you change something by running <span class="command"><strong>etckeeper
        commit "Descirption of the changes made"</strong></span>. The default
        Postfix configuration files were already commited when we installed
        Postfix.</p>
      </div>

      <p>First we are going to delete the content of the
      <code class="filename">/etc/postfix/main.cf</code> file so we can fill it with
      our own.</p>

      <pre class="programlisting">atlantis:~# <span class="command"><strong>cat</strong></span> /dev/null &gt; /etc/postfix/main.cf</pre>

      <p>Now copy and paste these lines, but make sure to replace
      <span class="emphasis"><em>myhostname = atlantis.example.com</em></span> with your
      hostname.</p>

      <pre class="screen">##################
# Default settings
##################
biff = no
append_dot_mydomain = no
#delay_warning_time = 4h
readme_directory = no
smtpd_banner = $myhostname ESMTP $mail_name

################
# TLS parameters
################
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

###############
# Main settings
###############
myhostname = <em class="replaceable"><code>atlantis.example.com</code></em>
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = $mydomain, localhost.$mydomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all</pre>

      <div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3>
        <p>Postfix extracts $mydomain from the value of the
        <code class="varname">myhostname</code> and strips the part before the first
        dot, including the dot. So in this case <code class="varname">mydomain</code> is
        <span class="emphasis"><em>example.com</em></span>.</p>
      </div>

      <p>If you are not using IPv6 you can remove IPv6 addresses from
      <code class="varname">mynetworks</code> and leave just <span class="emphasis"><em>mynetworks =
      127.0.0.0/8</em></span>. We will use the <code class="varname">mynetworks</code>
      variable to tell Postfix that all computers specified in the my networks
      range can send emails without authentification. We are leaving only the
      localhost here so we make sure that mail originating from the server
      (like outputs of cron jobs and other system messages) do not get blocked
      by other rules we will implement.</p>

      <p>Restart Postfix by running <span class="command"><strong>invoke-rc.d postfix
      restart</strong></span> and try to send another test mail to check that we
      didn't mess something up.</p>

      <p>Now it would be a good time to also test if Postfix is receiving
      mails as well. Try sending an email to just <code class="email">&lt;<a class="email" href="mailto:root">root</a>&gt;</code> and to
      <code class="email">&lt;<a class="email" href="mailto:root@example.com">root@example.com</a>&gt;</code> using the <span class="command"><strong>mail</strong></span>
      command as described in the <a class="link" href="#postfix.test-email-sending">previous section</a>. If
      everything works the received emails should be located in
      <code class="filename">/var/mail/root</code>. Check that file and make sure that
      you are sending email from the right domain (sender should be
      <code class="email">&lt;<a class="email" href="mailto:root@example.com">root@example.com</a>&gt;</code>). If you do not receive an email check
      the Postifx log file <code class="email">&lt;<a class="email" href="mailto:/var/log/mail.log">/var/log/mail.log</a>&gt;</code> to see what could
      have gone wrong.</p>
    </div>

    <div class="section" title="3.2.2. Virtual users and domains"><div class="titlepage"><div><div><h3 class="title"><a id="postfix.virtual-users"></a>3.2.2. Virtual users and domains</h3></div></div></div>
      

      <p>Our current setup can only receive mail for for users that exist
      on our server (root, the one that you created druing the installation
      and other system users). As you can see this is not quite helpfull as we
      could only server one domain and all the users that have email addresses
      on that domain would have to be created on the server.</p>

      <p>To avoid all this we are going to use virtual domains and users.
      That means that we are going to create a couple of databases where we
      will store all the domains and users that we will be receiving mail
      for.</p>

      <p>First, we are going to create a system user which will have
      persmissions to read and write emails to the system as well as the
      directory for storing all of the mail.</p>

      <p>User will be called <code class="systemitem">vmail</code> and will have a group with ID 5000
      on the system.</p>

      <pre class="programlisting"><span class="command"><strong>groupadd</strong></span> -g 5000 vmail
<span class="command"><strong>useradd</strong></span> -s /usr/sbin/nologin -g vmail -u 5000 vmail -d /home/vmail -m</pre>

      <p>The extra parameters for the <span class="command"><strong>useradd</strong></span> command
      tell the system that this user will not be able to log on to the system,
      that he belongs to group 5000 and that it's home folder is <code class="filename">/home/vmail</code>. This is the folder where all
      of the received messages will be stored.</p>
    </div>

    <div class="section" title="3.2.3. MySQL"><div class="titlepage"><div><div><h3 class="title"><a id="postfix.mysql"></a>3.2.3. MySQL</h3></div></div></div>
      

      <p></p>
    </div>
  </div>
</div>

  <div class="chapter" title="Chapter 4. TODO"><div class="titlepage"><div><div><h2 class="title"><a id="todo"></a>Chapter 4. TODO</h2></div></div></div>
  
  

      <div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
          <p>
              Fetching mail with mailman
          </p>
        </li><li class="listitem">
          <p>
              Mailing lists - Mailman
          </p>
        </li><li class="listitem">
          <p>
              Setting up satellite boxes
          </p>
        </li><li class="listitem">
          <p>
              DNS caching
          </p>
        </li><li class="listitem">
          <p>
              Disabling IPv6
          </p>
        </li></ul></div>
</div>
</div></body></html>
